(self.webpackChunkapp_studio_enterprise_duplicates_widget=self.webpackChunkapp_studio_enterprise_duplicates_widget||[]).push([[5788],{55788:(xe,de,g)=>{g.r(de),g.d(de,{BaseDataGridColumnEditHandler:()=>$,BaseDataGridStateHandlerService:()=>J,BooleanCellViewElementConfigCreator:()=>X,BooleanEditingCellViewElementConfigCreator:()=>G,CAN_CREATE_DEFAULT_GRID_SETTING_OPERATION_CODE:()=>Ve,CHECK_DATA_GRID_COLUMNS_RIGHTS_ON_LOAD:()=>fe,CellViewElementConfigCreator:()=>E,CrtDataGridCdkModule:()=>D,DATA_GRID_AVAILABLE_EDITING_DATA_VALUE_TYPES:()=>pe,DATA_GRID_CELL_VIEW_CONFIG_CREATOR_FACTORY:()=>re,DATA_GRID_CELL_VIEW_CONFIG_CREATOR_FACTORY_PROVIDER:()=>ve,DATA_GRID_EDITING_CELL_VIEW_CONFIG_CREATOR_FACTORY:()=>Ce,DATA_GRID_EDITING_CELL_VIEW_CONFIG_CREATOR_FACTORY_PROVIDER:()=>Fe,DISABLE_DATA_GRID_EDITING_MODE_FEATURE_CODE:()=>Se,DISABLE_DATA_GRID_MULTIPLE_ROWS_SELECTION_FEATURE_CODE:()=>Te,DataGridCancelItemsChangesHandler:()=>ie,DataGridCancelItemsChangesRequest:()=>se,DataGridColumnDefinitionService:()=>Q,DataGridRowDoubleClickHandler:()=>oe,DataGridRowDoubleClickRequest:()=>ue,DateTimeCellViewElementConfigCreator:()=>j,DateTimeEditingCellViewElementConfigCreator:()=>R,DcmStageCellViewElementConfigCreator:()=>F,DcmStageEditingCellViewElementConfigCreator:()=>M,EditingCellViewElementConfigCreator:()=>y,EmailCellViewElementConfigCreator:()=>V,EmailEditingCellViewElementConfigCreator:()=>O,FILE_LIST_CELL_VIEW_CONFIG_CREATOR_FACTORY:()=>ge,FILE_LIST_CELL_VIEW_CONFIG_CREATOR_FACTORY_PROVIDER:()=>we,FileCellViewElementConfigCreator:()=>I,FileSizeCellViewElementConfigCreator:()=>A,LookupCellViewElementConfigCreator:()=>Z,LookupEditingCellViewElementConfigCreator:()=>N,NativeLinkCellViewElementConfigCreator:()=>z,NumericCellViewElementConfigCreator:()=>k,NumericEditingCellViewElementConfigCreator:()=>b,PhoneCellViewElementConfigCreator:()=>T,PhoneEditingCellViewElementConfigCreator:()=>L,PrimaryCellViewElementConfigCreator:()=>W,RichTextCellViewElementConfigCreator:()=>v,SchemaDataGridColumnEditHandler:()=>q,SchemaDataGridColumnSelectionService:()=>ee,StructureExplorerDataGridColumnSelectionService:()=>K,TextCellViewElementConfigCreator:()=>B,TextEditingCellViewElementConfigCreator:()=>w,WebEditingCellViewElementConfigCreator:()=>x});var o=g(94450),_=g(34038),S=g(14537),Y=g(52045),m=g(21322),C=g(27049);class J{get viewModel$(){return this.injector?this.injector.get(S.BINDING_CONTEXT).viewModel$.pipe((0,C.take)(1)):(0,m.of)(null)}constructor(e){this.schemaService=e}getColumnsFromSchema(e){const t=e?.columns??[];if(typeof t=="string"){const n=t.split("$").pop();return this.viewModel$.pipe((0,C.map)(a=>(a?.attributes??{})[n]||[]))}return(0,m.of)(t)}getDataSourceName(e){const t=(0,_.getViewModelItemsAttributeName)(e);return this.viewModel$.pipe((0,C.map)(n=>n?.getBoundDataSourceNameByAttributePath(t)))}handle(e,t){this.injector=t;const n=t.get(S.VIEW_ELEMENT_CONFIG),a=this.schemaService.getViewConfigInfoByName(n.name).viewConfig,i=e.columns??[];return this.getDataSourceName(a).pipe((0,C.switchMap)(s=>s?this.getColumnsFromSchema(a).pipe((0,C.switchMap)(l=>{const d={viewElementConfig:a,dataSourceName:s,columns:i,previousColumns:l};return this.innerHandle(d)})):(0,m.of)(void 0)))}}J.\u0275fac=function(e){return new(e||J)(o.\u0275\u0275inject(Y.SchemaService))},J.\u0275prov=o.\u0275\u0275defineInjectable({token:J,factory:J.\u0275fac});var u=g(8239),c=g(75378),me=g(77207),Ee=g(59929),f=g(49475),P=g(97600);class ${constructor(e){this._translateService=e.get(me.TranslateService),this._columnEditService=e.get(_.DataGridColumnEditService),this._entitySchemaService=e.get(f.EntitySchemaService),this._entitySchemaProvider=e.get(f.EntitySchemaProvider),this.schemaService=e.get(Y.SchemaService)}_replaceColumn(e,t,n){if(!e)return n;const a=(0,P.findIndex)(n,i=>i.id===t);return n[a]={...e,changed:!0},n}_getEntitySchemaName(e,t){if(!e)return null;const a=t.getBoundDataSchemaByAttributePath(e)?.dataSourceConfig;return a?.type!=="crt.EntityDataSource"?null:a.config?.entitySchemaName}getResources(e,t){return Promise.resolve(this.schemaService.resources)}processColumns(e,t,n){var a=this;return(0,u.Z)(function*(){const i=yield a.getResources(e,t),s=(0,_.getDataGridItemsAttributeName)(e),l=a._getEntitySchemaName(s,t);for(const d of n)yield a._setColumnModelProperties(d,t,l,s),a.setColumnCaptionResources(d,i,e);return{dataSourceSchemaName:l,columns:n}})()}_setColumnModelProperties(e,t,n,a){var i=this;return(0,u.Z)(function*(){if(!a||!n||!e.code)return;const s=`${a}.${e.code}`,l=t.getBoundDataSchemaAttributeByAttributePath(s);if(!l?.path||l.attributeType!==c.DataSchemaAttributeType.AggregationAttribute)return;const d=yield i.getEntitySchemaNameByPath(n,l.path);e.path=l.path,e.aggregationConfig=l.aggregationConfig||e.aggregationConfig,e.referenceSchemaName=d||e.referenceSchemaName})()}_processColumnOriginalCaption(e,t){const n=t.path,a=n?.startsWith("[")?t.referenceSchemaName:e;return!n||!a||!t.aggregationConfig?(0,m.of)(t):this._entitySchemaProvider.getSchemaByName(a).pipe((0,C.switchMap)(i=>this._entitySchemaService.getEntitySchemaColumnsInformationByPath(i.uId,n," > ")),(0,C.map)(i=>{let s=i.columnCaptionPath;const l=t.aggregationConfig?.aggregationFunction;return l&&(s=this._getAggregationColumnOriginalCaption(s,t.dataValueType,l)),t.originalCaption=s,t}))}_getAggregationColumnOriginalCaption(e,t,n){const a=(0,Ee.getAllowedAggregationFunctionsByDataValueType)(t);a.push({func:c.AggregationFunction.Count,captionResource:"Count"});const i=a.find(l=>l.func===n)?.captionResource||"",s=this._getAggregationFunctionCaption(i);return n===c.AggregationFunction.TopOne?this._translateService.currentLang===f.DEFAULT_CULTURE_NAME?`${e} (the ${s.toLowerCase()})`:`${e} (${s.toLowerCase()})`:n===c.AggregationFunction.Count?`${e.split(" > ").slice(0,-1).join(" > ")} ${s}`:`${e} ${s}`}_getAggregationFunctionCaption(e){return this._translateService.instant("AggregationNames."+e)}onColumnPreparationFinished(){}handle(e,t,n){const a=n.get(S.VIEW_ELEMENT_CONFIG),i=this.schemaService.getViewConfigInfoByName(a.name).viewConfig;return n.get(S.BINDING_CONTEXT).viewModel$.pipe((0,C.take)(1)).pipe((0,C.mergeMap)(d=>this.processColumns(i,d,t)),(0,C.mergeMap)(d=>{const p=(0,P.cloneDeep)(d.columns.find(h=>h.id===e));return this._processColumnOriginalCaption(d.dataSourceSchemaName,p).pipe((0,m.tap)(()=>this.onColumnPreparationFinished()),(0,C.mergeMap)(h=>this._columnEditService.edit(h,n).pipe((0,C.map)(ne=>this._replaceColumn(ne,e,d.columns)))))}))}}$.\u0275fac=function(e){return new(e||$)(o.\u0275\u0275inject(o.Injector))},$.\u0275prov=o.\u0275\u0275defineInjectable({token:$,factory:$.\u0275fac});var _e=g(18369),le=g(33177),ye=g(96923),De=g(54134);const re=new o.InjectionToken("A cell view config factory"),Ce=new o.InjectionToken("A factory of editing cell view config creators"),ge=new o.InjectionToken("A cell view config factory");class K{constructor(e,t,n,a){this.structureExplorer=e,this.schemaService=t,this.cellViewConfigCreatorFactory=n,this.translateService=a}_openStructureExplorer(e){return this.structureExplorer.show({providers:[e],enableMultiSelection:!0,collectDrillDownItems:!0})}_getColumnCaptionResourceMacros(e,t){const n=t.split(".").join("");return`#ResourceString(${e}_${n})#`}_getStructureExplorerDataProviderConfig(e,t){const n=e.getBoundDataSourceNameByAttributePath(t);return{name:ye.DATA_SOURCE_STRUCTURE_EXPLORER_DATA_PROVIDER_NAME,navigateOnlyThroughDataSource:n,options:{useBackwards:!0}}}_modifyAggregationColumnCode(e,t){return e+t+De.Guid.create().toString().slice(0,8)}createColumnDefinition(e){const{structureExplorerItem:t,dataSourceName:n}=e,a=this.getColumnName(t.columnPath),i=t.data?.item?.aggregationFunction;let s=`${n}_${a}`;i&&(s=this._modifyAggregationColumnCode(s,i));const l=t.data.dataValueType,d=i?this.getAggregationColumnCaption(t.caption,t.data.item.aggregationFunctionCaption,t.data.item.aggregationFunction):this._getColumnCaptionResourceMacros(n,a),p=t.data.isMasked,h={id:(0,c.generateGuid)(),code:s,path:t.columnPath,caption:d,dataValueType:l,referenceSchemaName:t.data?.item?.referenceSchemaName,isMasked:p};return i&&(h.aggregationConfig={aggregationFunction:t.data?.item?.aggregationFunction},i===c.AggregationFunction.TopOne&&(h.aggregationConfig.sortByColumn="Id",h.aggregationConfig.sortByDirection=c.OrderDirection.Asc),h.captionResources=new f.LocalizableStringArray,h.captionResources.setValueLocalizableString(this.translateService.currentLang,this.getAggregationColumnCaption(t.caption,t.data.item.aggregationFunctionCaption,t.data.item.aggregationFunction)),h.captionResourcesChanged=!0),{...h}}getItemsAttributeName(e){const t=e.get(S.VIEW_ELEMENT_CONFIG),n=this.schemaService.getViewConfigInfoByName(t.name).viewConfig;return(0,_.getViewModelItemsAttributeName)(n)}getAggregationColumnCaption(e,t,n){return n===c.AggregationFunction.TopOne?this.translateService.currentLang===f.DEFAULT_CULTURE_NAME?`${e} (the ${t.toLowerCase()})`:`${e} (${t.toLowerCase()})`:`${e} ${t}`}getColumnName(e){return(0,f.removeSpecialSymbols)(e)}selectColumns(e){const n=e.get(S.BINDING_CONTEXT).viewModel$.pipe((0,C.take)(1)),a=this.getItemsAttributeName(e);if(!a)return(0,m.of)([]);const i=n.pipe((0,C.map)(l=>l?.getBoundDataSourceNameByAttributePath(a))),s=n.pipe((0,C.map)(l=>this._getStructureExplorerDataProviderConfig(l,a)),(0,C.switchMap)(l=>this._openStructureExplorer(l)));return(0,m.forkJoin)([s,i]).pipe((0,C.map)(([l,d])=>(l??[]).filter(p=>p.id!==d).map(p=>this.createColumnDefinition({structureExplorerItem:p,dataSourceName:d}))))}}K.\u0275fac=function(e){return new(e||K)(o.\u0275\u0275inject(_e.StructureExplorerService),o.\u0275\u0275inject(Y.SchemaService),o.\u0275\u0275inject(re),o.\u0275\u0275inject(me.TranslateService))},K.\u0275prov=o.\u0275\u0275defineInjectable({token:K,factory:K.\u0275fac});class E{constructor(){this.type=""}getDisplayValue(e){const{column:t,itemsAttributeName:n}=e??{};return`${n}.${t?.code}`}getViewElementConfig(e){var t=this;return(0,u.Z)(function*(){const{column:n}=e??{};return{column:{...n},value:t.getDisplayValue(e),type:t.type}})()}}class B extends E{constructor(){super(...arguments),this.type="crt.TableTextCell"}}B.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(B)))(t||B)}}(),B.\u0275prov=o.\u0275\u0275defineInjectable({token:B,factory:B.\u0275fac,providedIn:"root"});class j extends E{constructor(){super(...arguments),this.type="crt.TableDateTimeCell"}}j.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(j)))(t||j)}}(),j.\u0275prov=o.\u0275\u0275defineInjectable({token:j,factory:j.\u0275fac,providedIn:"root"});class k extends E{constructor(){super(...arguments),this.type="crt.TableNumericCell"}}k.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(k)))(t||k)}}(),k.\u0275prov=o.\u0275\u0275defineInjectable({token:k,factory:k.\u0275fac,providedIn:"root"});var U=g(24709);class H extends E{constructor(){super(),this.type="crt.Link"}hasSectionEditPage(e){var t=this;return(0,u.Z)(function*(){const n=yield t.getReferenceSchemaName(e),a={type:"crt.7XRequest",action:"HasEntityEditPage",$context:e.context,payload:{entityName:n}};return yield c.HandlerChainService.instance.process(a)})()}getDefaultViewElementConfig(e){var t=()=>super.getViewElementConfig,n=this;return(0,u.Z)(function*(){const a=yield t().call(n,e);return a.type="crt.TableTextCell",a})()}getViewElementConfig(e){var t=this;return(0,u.Z)(function*(){return(yield t.hasSectionEditPage(e))?t.getLinkViewElementConfig(e):t.getDefaultViewElementConfig(e)})()}}H.\u0275fac=function(e){return new(e||H)},H.\u0275prov=o.\u0275\u0275defineInjectable({token:H,factory:H.\u0275fac});class W extends H{constructor(){super()}getReferenceSchemaName(e){return(0,u.Z)(function*(){const t=e?.primaryAttributeName??"";return(yield(0,U.getEntitySchemaAttribute)(e.context,e.itemsAttributeName.substring(1)+"."+t))?.referenceSchemaName})()}getLinkViewElementConfig(e){var t=this;return(0,u.Z)(function*(){const{itemsAttributeName:n,primaryAttributeName:a,column:i}=e,s=t.getDisplayValue(e);return{column:i,caption:s,type:t.type,href:`${n}.${a} | crt.ToRecordLinkAsync : '${a}'`,mode:"preventDefault",clicked:{request:"crt.UpdateRecordRequest",params:{itemsAttributeName:n.slice(1),recordId:`${n}.${a}`}}}})()}}W.\u0275fac=function(e){return new(e||W)},W.\u0275prov=o.\u0275\u0275defineInjectable({token:W,factory:W.\u0275fac,providedIn:"root"});var ae=g(41307);class Z extends H{constructor(e,t,n){super(),this._featureService=e,this._entitySchemaRepository=t,this._dcmSchemaManagerService=n,this._colorizedSchemasMap=new Map,this.type="crt.Link"}_isColumnColorized(e){var t=this;return(0,u.Z)(function*(){const n=yield(0,m.lastValueFrom)(t._featureService.getFeatureState("DisableDataGridColoredCell")),a=yield t.getReferenceSchemaName(e);if(!a||n)return Promise.resolve(!1);const i=t._colorizedSchemasMap.get(a);return i!==void 0?i:(0,m.lastValueFrom)(t._entitySchemaRepository.getSchemaByName(a).pipe((0,m.map)(s=>{const l=!!s.getPrimaryColorColumn();return t._colorizedSchemasMap.set(a,l),l}),(0,m.catchError)(()=>(0,m.of)(!1))))})()}_decorateConfigWithColorization(e,t){const n=super.getDisplayValue(t);e.type="crt.TableColoredCell",e.displayValue=n}_isStageColumn(e){var t=this;return(0,u.Z)(function*(){const n=yield(0,m.lastValueFrom)(t._featureService.getFeatureState("DisableDataGridProgressBarStageCell"));if(!e.dataGridSchemaName||n)return Promise.resolve(!1);const a=yield(0,m.firstValueFrom)(t._entitySchemaRepository.getSchemaByName(e.dataGridSchemaName)),i=(yield(0,m.firstValueFrom)(t._dcmSchemaManagerService.getDcmSchemaDataCollection())).find(l=>l.entitySchemaUId===a.uId&&l.isActive&&l.isActiveVersion);if(!i)return Promise.resolve(!1);const s=a.columns?.find(l=>l.uId===i.stageColumnUId)?.name;return s?e.column.code.split("_").pop()===s:Promise.resolve(!1)})()}_decorateConfigWithSlider(e,t){const n=`${t.dataGridName}_DCMData`;e.type="crt.TableSliderCell";const a=t.column?.code??"",s=`${`${t.itemsAttributeName}.${a}`} | crt.ToEntityStageDataTableSliderConverterAsync:$${n}`;e.percentage=`${s} | crt.ToObjectProp : 'value'`,e.color=`${s} | crt.ToObjectProp : 'color'`,e.value=this.getDisplayValue(t)}getDisplayValue(e){return`${super.getDisplayValue(e)} | crt.ToObjectProp : 'displayValue'`}getReferenceSchemaName(e){return(0,u.Z)(function*(){const t=e?.column.code??"";return(yield(0,U.getEntitySchemaAttribute)(e.context,e.itemsAttributeName.substring(1)+"."+t))?.referenceSchemaName})()}getDefaultViewElementConfig(e){var t=()=>super.getDefaultViewElementConfig,n=this;return(0,u.Z)(function*(){const a=yield t().call(n,e),i=yield n._isColumnColorized(e),s=yield n._isStageColumn(e),l=e.column.code.startsWith(U.DYNAMIC_DATA_SOURCE_PREFIX);return s&&!l?n._decorateConfigWithSlider(a,e):i&&n._decorateConfigWithColorization(a,e),a})()}getLinkViewElementConfig(e){var t=this;return(0,u.Z)(function*(){const{itemsAttributeName:n,column:a}=e,i=t.getDisplayValue(e),s=yield t.getReferenceSchemaName(e),l=a?.code??"",d=`${n}.${l} | crt.ToObjectProp : 'value' | crt.ToRecordLinkAsync : '${l}'`,p={type:"crt.Link",column:{...a},caption:i,href:d,mode:"preventDefault",clicked:{request:"crt.UpdateRecordRequest",params:{entityName:s,recordId:`${n}.${l} | crt.ToObjectProp : "value"`}}},h=yield t._isColumnColorized(e),ne=yield t._isStageColumn(e),ce=e.column.code.startsWith(U.DYNAMIC_DATA_SOURCE_PREFIX);return ne&&!ce?t._decorateConfigWithSlider(p,e):h&&t._decorateConfigWithColorization(p,e),p})()}}Z.\u0275fac=function(e){return new(e||Z)(o.\u0275\u0275inject(ae.FeatureService),o.\u0275\u0275inject(f.EntitySchemaRepository),o.\u0275\u0275inject(ae.DcmSchemaManagerService))},Z.\u0275prov=o.\u0275\u0275defineInjectable({token:Z,factory:Z.\u0275fac,providedIn:"root"});class X extends E{constructor(e){super(),this._defaultFeatures=e,this.type="crt.TableBooleanCell"}_getEditingModeDisabledExpression(e){if((0,Y.isBindingExpression)(e))return`${e} | crt.PickDataGridFeatureValue : 'editable.enable' | crt.InvertBooleanValue`;const t=(0,_.fullInDataTableEditingFeatures)(e?.editable,!0);return!(0,_.fullInDataTableEditingFeatures)(this._defaultFeatures?.editable,!1).enable||!t.enable}getViewElementConfig(e){var t=()=>super.getViewElementConfig,n=this;return(0,u.Z)(function*(){const a=yield t().call(n,e),i=n.getDisplayValue(e),s=e.column.readonly===!0,l=n._getEditingModeDisabledExpression(e.features);return{...a,control:i,readonly:s||l,bindTo:i,readiness:`$${U.BUSINESS_RULES_ACTIVATED_SYSTEM_ATTRIBUTE_NAME}`}})()}}X.\u0275fac=function(e){return new(e||X)(o.\u0275\u0275inject(_.DATA_GRID_FEATURES,8))},X.\u0275prov=o.\u0275\u0275defineInjectable({token:X,factory:X.\u0275fac,providedIn:"root"});class T extends E{constructor(){super(...arguments),this.type="crt.TablePhoneCell"}}T.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(T)))(t||T)}}(),T.\u0275prov=o.\u0275\u0275defineInjectable({token:T,factory:T.\u0275fac,providedIn:"root"});class V extends E{constructor(){super(...arguments),this.type="crt.TableEmailCell"}}V.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(V)))(t||V)}}(),V.\u0275prov=o.\u0275\u0275defineInjectable({token:V,factory:V.\u0275fac,providedIn:"root"});class I extends E{constructor(){super(...arguments),this.type="crt.TableFileCell"}getViewElementConfig(e){var t=this;return(0,u.Z)(function*(){const{itemsAttributeName:n,primaryAttributeName:a,dataSchemaName:i,column:s}=e;return{column:{...s},fileName:t.getDisplayValue(e),fileUrl:`${n}.${a} | crt.ToFileLink : '${i}'`,type:t.type}})()}}I.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(I)))(t||I)}}(),I.\u0275prov=o.\u0275\u0275defineInjectable({token:I,factory:I.\u0275fac,providedIn:"root"});class A extends E{constructor(){super(...arguments),this.type="crt.TableFileSizeCell"}}A.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(A)))(t||A)}}(),A.\u0275prov=o.\u0275\u0275defineInjectable({token:A,factory:A.\u0275fac,providedIn:"root"});class v extends E{constructor(){super(...arguments),this.type="crt.TableRichTextEditorCell"}}v.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(v)))(t||v)}}(),v.\u0275prov=o.\u0275\u0275defineInjectable({token:v,factory:v.\u0275fac,providedIn:"root"});class z extends E{constructor(){super(),this.type="crt.Link"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,n=this;return(0,u.Z)(function*(){const a=yield t().call(n,e),i=e.column.dataValueType===c.DataValueType.EMAIL_TEXT;return a.href=i?`${a.value} | crt.ToEmailLink`:`${a.value} | crt.LinkPrefix`,a.caption=`${a.value}`,a.mode="native",a.target=i?"_self":"_blank",a})()}}z.\u0275fac=function(e){return new(e||z)},z.\u0275prov=o.\u0275\u0275defineInjectable({token:z,factory:z.\u0275fac,providedIn:"root"});class F extends E{constructor(){super(...arguments),this.type="crt.TableDcmStageCell"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,n=this;return(0,u.Z)(function*(){const a=yield t().call(n,e),i=n.getDisplayValue(e);return{...a,value:i,bindTo:i,dcmStages:"$DcmStages"}})()}}F.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(F)))(t||F)}}(),F.\u0275prov=o.\u0275\u0275defineInjectable({token:F,factory:F.\u0275fac,providedIn:"root"});class y{constructor(){this.type=""}getColumnDataSchemaAttribute(e){const{column:t,context:n,itemsAttributeName:a}=e,i=(0,_.getDataGridItemsAttributeName)({items:a});if(!t.code||!i)return null;const s=`${i}.${t.code}`;return n.getBoundDataSchemaAttributeByAttributePath(s)}getViewElementConfig(e){var t=this;return(0,u.Z)(function*(){const{column:n,itemsAttributeName:a}=e??{};return{type:t.type,control:`${a}.${n.code}`,bindTo:`${a}.${n.code}`}})()}}class w extends y{constructor(){super(...arguments),this.type="crt.DataTableEditTextCell"}}w.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(w)))(t||w)}}(),w.\u0275prov=o.\u0275\u0275defineInjectable({token:w,factory:w.\u0275fac,providedIn:"root"});class b extends y{constructor(){super(...arguments),this.type="crt.DataTableEditNumericCell"}}b.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(b)))(t||b)}}(),b.\u0275prov=o.\u0275\u0275defineInjectable({token:b,factory:b.\u0275fac,providedIn:"root"});class N extends y{constructor(){super(...arguments),this.type="crt.DataTableEditLookupCell"}}N.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(N)))(t||N)}}(),N.\u0275prov=o.\u0275\u0275defineInjectable({token:N,factory:N.\u0275fac,providedIn:"root"});class R extends y{constructor(){super(...arguments),this._dataValueTypeToDateType=new Map([[c.DataValueType.Date,f.DateTypes.Date],[c.DataValueType.Time,f.DateTypes.Time],[c.DataValueType.DateTime,f.DateTypes.DateTime]]),this.type="crt.DataTableEditDateTimeCell"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,n=this;return(0,u.Z)(function*(){const{column:a}=e??{};return{...yield t().call(n,e),dateType:n._dataValueTypeToDateType.get(a.dataValueType)??f.DateTypes.DateTime}})()}}R.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(R)))(t||R)}}(),R.\u0275prov=o.\u0275\u0275defineInjectable({token:R,factory:R.\u0275fac,providedIn:"root"});class G extends y{getViewElementConfig(e){return(0,u.Z)(function*(){return null})()}}G.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(G)))(t||G)}}(),G.\u0275prov=o.\u0275\u0275defineInjectable({token:G,factory:G.\u0275fac,providedIn:"root"});class L extends y{constructor(){super(...arguments),this.type="crt.DataTableEditPhoneCell"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,n=this;return(0,u.Z)(function*(){const a=yield t().call(n,e);if(!e?.context)return a;const i=n.getColumnDataSchemaAttribute(e);return i?{...a,displayAsPhone:i.isMasked}:a})()}}L.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(L)))(t||L)}}(),L.\u0275prov=o.\u0275\u0275defineInjectable({token:L,factory:L.\u0275fac,providedIn:"root"});class O extends y{constructor(){super(...arguments),this.type="crt.DataTableEditEmailCell"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,n=this;return(0,u.Z)(function*(){const a=yield t().call(n,e);if(!e?.context)return a;const i=n.getColumnDataSchemaAttribute(e);return i?{...a,isFormatValidated:i.isFormatValidated}:a})()}}O.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(O)))(t||O)}}(),O.\u0275prov=o.\u0275\u0275defineInjectable({token:O,factory:O.\u0275fac,providedIn:"root"});class x extends y{constructor(){super(...arguments),this.type="crt.DataTableEditWebCell"}}x.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(x)))(t||x)}}(),x.\u0275prov=o.\u0275\u0275defineInjectable({token:x,factory:x.\u0275fac,providedIn:"root"});class M extends y{constructor(){super(...arguments),this.type="crt.TableDcmStageEditingCell"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,n=this;return(0,u.Z)(function*(){return{...yield t().call(n,e),column:{},dcmStages:"$DcmStages"}})()}}M.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(M)))(t||M)}}(),M.\u0275prov=o.\u0275\u0275defineInjectable({token:M,factory:M.\u0275fac,providedIn:"root"});const fe="CheckDataGridColumnsRightsOnLoad",Se="DisableDataGridEditingMode",Te="DisableDataGridMultipleRowsSelection",Ve="CanCreateDefaultGridSettings",pe=[c.DataValueType.Guid,c.DataValueType.Text,c.DataValueType.Integer,c.DataValueType.Float,c.DataValueType.Money,c.DataValueType.DateTime,c.DataValueType.Date,c.DataValueType.Time,c.DataValueType.Lookup,c.DataValueType.Enum,c.DataValueType.Boolean,c.DataValueType.SHORT_TEXT,c.DataValueType.MEDIUM_TEXT,c.DataValueType.MAXSIZE_TEXT,c.DataValueType.LONG_TEXT,c.DataValueType.FLOAT1,c.DataValueType.FLOAT2,c.DataValueType.FLOAT3,c.DataValueType.FLOAT4,c.DataValueType.FLOAT8,c.DataValueType.PHONE_TEXT,c.DataValueType.WEB_TEXT,c.DataValueType.EMAIL_TEXT];class Q{constructor(e,t,n){this._cellViewConfigCreatorFactory=e,this._rightsService=t,this._featureService=n}_getColumnName(e){return e.dataValueType===c.DataValueType.Lookup?`${e.path}Id`:e.path}_getColumnsAccessRights(e){const t=(0,P.uniq)(e.attributes.map(this._getColumnName));return this._featureService.getFeatureState(fe).pipe((0,C.switchMap)(a=>a?this._requestColumnsAccessRights(e.name,t):this._allowColumnsAccessRights(t)))}_allowColumnsAccessRights(e){const t={};return e.forEach(n=>t[n]=!0),(0,m.of)(t)}_requestColumnsAccessRights(e,t){return this._rightsService.getCanEditColumns({schemaName:e,columnNames:t})}_isReadonlyColumn(e,t){const n=this._getColumnName(t),a=!U.DATA_SCHEMA_SYSTEM_COLUMNS.includes(t.path),i=t.attributeType===c.DataSchemaAttributeType.OwnAttribute,s=pe.includes(t.dataValueType);return!(e[n]&&i&&a&&s)}_generateColumnDefinition(e,t,n){const{dataSourceName:a,dataSchema:i,itemsAttributeName:s,viewModel:l,features:d,dataGridName:p}=e,h=t.name,{primaryAttributeName:ne,primaryDisplayAttributeName:ce,name:be}=i??{},Ne=ne&&`${a}_${ne}`,Re={columnName:h,dataValueType:t.dataValueType,primaryDisplayAttributeName:ce},Ge={column:{...n,id:(0,c.generateGuid)()},context:l,itemsAttributeName:s,features:d,primaryAttributeName:Ne,primaryDisplayAttributeName:ce,columnName:h,dataGridName:p,dataGridSchemaName:be},Le=this._cellViewConfigCreatorFactory.create(Re)?.getViewElementConfig(Ge)??(0,m.of)(null);return(0,m.from)(Le).pipe((0,C.map)(Oe=>({...n,cellView:Oe})))}processDataGridColumnDefinitions(e,t){const{dataSourceName:n,dataSchema:a}=e;return this._getColumnsAccessRights(a).pipe((0,C.switchMap)(i=>{const s=t.map(l=>{const d=a.attributes.find(p=>(0,f.removeSpecialSymbols)(`${n}_${p.name}`)===l.code);return d?(0,P.isUndefined)(l.readonly)?this._generateColumnDefinition(e,d,{...l,readonly:this._isReadonlyColumn(i,d)}):this._generateColumnDefinition(e,d,l):(0,m.of)(l)});return(0,m.forkJoin)(s)}))}getDataGridColumnDefinition(e,t,n){const{dataSchema:a,dataSourceName:i}=e;return this._getColumnsAccessRights(a).pipe((0,C.switchMap)(s=>{const l=`${i}_${t.name}`,d=(0,c.generateGuid)(),p={id:d,code:(0,f.removeSpecialSymbols)(l),caption:n||`#ResourceString(${d.split("-")[0]})#`,dataValueType:t.dataValueType,readonly:this._isReadonlyColumn(s,t)};return this._generateColumnDefinition(e,t,p)}))}}Q.\u0275fac=function(e){return new(e||Q)(o.\u0275\u0275inject(re),o.\u0275\u0275inject(ae.RightsService),o.\u0275\u0275inject(ae.FeatureService))},Q.\u0275prov=o.\u0275\u0275defineInjectable({token:Q,factory:Q.\u0275fac,providedIn:"root"});var Ie=g(29989),Ae=g.n(Ie);class q extends ${constructor(e,t,n,a,i,s){super(e),this._maskService=t,this._metadataModifier=n,this._schemaPartService=a,this._entitySchemaRepository=i,this._dataGridActiveFolderDesignSettingsProvider=s}_getResourcesFromProfile(){var e=this;return(0,u.Z)(function*(){const[,t]=yield e._schemaPartService.use("USER"),n=yield t.loadResources();return{strings:(0,P.cloneDeep)(n?.localizableStrings)}})()}_getResourcesFromActiveFolderSettings(e,t){var n=this;return(0,u.Z)(function*(){const a=yield n._dataGridActiveFolderDesignSettingsProvider.get({viewConfig:e,viewModel:t,metadata:n.schemaService.schema});return{strings:(0,P.cloneDeep)(a?.resources?.localizableStrings??{})}})()}getResources(e,t){var n=this;return(0,u.Z)(function*(){const a=yield n._getResourcesFromProfile(),i=yield n._getResourcesFromActiveFolderSettings(e,t);return Ae()(a,i)})()}getEntitySchemaNameByPath(e,t){const n=t.split("."),a=this._entitySchemaRepository.findEntitySchemaByPath(e,n);return Promise.resolve(a?.name)}setColumnCaptionResources(e,t,n){const a=this._metadataModifier.revert((0,P.cloneDeep)(e)),i=(0,f.extractResourcesKey)(a.caption);!i||(e.captionResources=(0,f.toLocalizableStringsArray)(t.strings,i))}processColumns(e,t,n){return this._maskService.showBodyMask(),super.processColumns(e,t,n)}onColumnPreparationFinished(){this._maskService.hideBodyMask()}}q.\u0275fac=function(e){return new(e||q)(o.\u0275\u0275inject(o.Injector),o.\u0275\u0275inject(c.MaskService),o.\u0275\u0275inject(U.MetadataModifierService),o.\u0275\u0275inject(Y.SchemaPartsService),o.\u0275\u0275inject(f.EntitySchemaRepository),o.\u0275\u0275inject(_.DataGridActiveFolderDesignSettingsProvider))},q.\u0275prov=o.\u0275\u0275defineInjectable({token:q,factory:q.\u0275fac});class ee{constructor(e){this._columnSelectionService=e}_canSelectColumns(e){if(e===null)return(0,m.of)(!1);const t={type:"crt.CanDiscardUnsavedDataRequest",$context:e},n=c.HandlerChainService.instance.process(t);return(0,m.from)(n)}_getDataGridCollection(e,t){const n=e.get(S.VIEW_ELEMENT_CONFIG),a=(0,_.getViewModelItemsAttributeName)(n);return a?(0,m.from)(t[a]).pipe((0,C.map)(i=>i)):(0,m.of)(null)}selectColumns(e){return e.get(S.BINDING_CONTEXT).viewModel$.pipe((0,C.switchMap)(t=>this._getDataGridCollection(e,t)),(0,C.switchMap)(t=>this._canSelectColumns(t)),(0,C.switchMap)(t=>(0,m.iif)(()=>t,this._columnSelectionService.selectColumns(e),(0,m.of)([]))),(0,C.take)(1))}}ee.\u0275fac=function(e){return new(e||ee)(o.\u0275\u0275inject(_.DataGridColumnSelectionService))},ee.\u0275prov=o.\u0275\u0275defineInjectable({token:ee,factory:ee.\u0275fac});const ve=le.FactoryProvider.create({token:re,mappings:[{predicate:({columnName:r,primaryDisplayAttributeName:e})=>Boolean(r)&&r===e,injectable:W},{predicate:({dataValueType:r})=>r===c.DataValueType.Lookup,injectable:Z},{predicate:({dataValueType:r})=>r===c.DataValueType.Boolean,injectable:X},{predicate:({dataValueType:r})=>r===c.DataValueType.PHONE_TEXT,injectable:T},{predicate:({dataValueType:r})=>r===c.DataValueType.EMAIL_TEXT,injectable:V},{predicate:({dataValueType:r})=>r===c.DataValueType.RICH_TEXT,injectable:v},{predicate:({dataValueType:r})=>r===c.DataValueType.EMAIL_TEXT||r===c.DataValueType.WEB_TEXT,injectable:z},{predicate:({dataValueType:r,columnName:e})=>r===c.DataValueType.Guid&&e.includes("DcmStageValue"),injectable:F}]}),Fe=le.FactoryProvider.create({token:Ce,mappings:[{predicate:({dataValueType:r})=>f.DATE_TIME_DATA_VALUE_TYPES.includes(r),injectable:R},{predicate:({dataValueType:r})=>f.NUMERIC_DATA_VALUE_TYPES.includes(r),injectable:b},{predicate:({dataValueType:r})=>r===c.DataValueType.Lookup,injectable:N},{predicate:({dataValueType:r})=>r===c.DataValueType.Boolean,injectable:G},{predicate:({dataValueType:r})=>r===c.DataValueType.PHONE_TEXT,injectable:L},{predicate:({dataValueType:r})=>r===c.DataValueType.EMAIL_TEXT,injectable:O},{predicate:({dataValueType:r})=>r===c.DataValueType.WEB_TEXT,injectable:x},{predicate:({dataValueType:r,columnName:e})=>r===c.DataValueType.Guid&&e.includes("DcmStageValue"),injectable:M}],default:{injectable:w}}),we=le.FactoryProvider.create({token:ge,mappings:[{predicate:({columnName:r,primaryDisplayAttributeName:e})=>r&&r===e,injectable:I},{predicate:({columnName:r})=>r&&r==="Size",injectable:A}]});var te=g(74742);let se=class extends c.BaseRequest{constructor(){super(...arguments),this.type="crt.DataGridCancelItemsChangesRequest"}};se=(0,te.__decorate)([(0,c.CrtRequest)({type:"crt.DataGridCancelItemsChangesRequest"})],se);let ie=class extends c.BaseRequestHandler{constructor(e){super(),this._schemaService=e}_canCancelItemsChanges(e){var t=this;return(0,u.Z)(function*(){const{$context:n,itemsAttributeName:a,changedItems:i}=e;if(!n||!a)return!1;if(i&&i.length>0)return!0;const s=yield n[a],l={type:"crt.CanDiscardUnsavedDataRequest",$context:s};return yield t.handlerChain.process(l)})()}_cancelItemsChanges(e){var t=this;return(0,u.Z)(function*(){const n={type:"crt.CancelRecordsChangesRequest",$context:e.$context,recordIds:e.changedItems,itemsAttributeName:e.itemsAttributeName};return yield t.handlerChain.process(n)})()}_getDataGridViewConfigs(e){return this._schemaService.getViewConfigInfoByFilter(t=>{const{type:n,items:a}=t;return n==="crt.DataGrid"&&a===`$${e}`}).map(t=>t.viewConfig)}_cleanupSelectionState(e,t){const n=this._getDataGridViewConfigs(e).map(a=>a?._selectionOptions?.attribute||(0,_.createDataGridSelectionStateAttributeName)(a)).map(a=>this.handlerChain.process({type:"crt.ChangeViewModelAttributeValueRequest",$context:t,attributeName:a,attributeValue:null}));return Promise.all(n)}handle(e){var t=this;return(0,u.Z)(function*(){return e?(yield t._canCancelItemsChanges(e))?t._cancelItemsChanges(e):(yield t._cleanupSelectionState(e.itemsAttributeName,e.$context),!1):!1})()}};ie=(0,te.__decorate)([(0,c.CrtRequestHandler)({type:"crt.DataGridCancelItemsChangesHandler",requestType:"crt.DataGridCancelItemsChangesRequest"}),(0,te.__metadata)("design:paramtypes",[Y.SchemaService])],ie);let ue=class extends c.BaseRequest{};ue=(0,te.__decorate)([(0,c.CrtRequest)({type:"crt.DataGridRowDoubleClickRequest"})],ue);let oe=class extends c.BaseRequestHandler{_isClickByNewRecord(e){return(0,u.Z)(function*(){const{itemsAttributeName:t,rowId:n}=e;return!t||!n?!1:(yield(yield e.$context[t])?.findByPrimaryAttribute(n))?.getPrimaryModelMode()===f.ModelMode.Create})()}_createUpdateRecordRequest(e){return{type:"crt.UpdateRecordRequest",$context:e.$context,recordId:e.rowId,itemsAttributeName:e.itemsAttributeName}}handle(e){var t=this;return(0,u.Z)(function*(){return(yield t._isClickByNewRecord(e))?Promise.resolve():t.handlerChain.process(t._createUpdateRecordRequest(e))})()}};oe=(0,te.__decorate)([(0,c.CrtRequestHandler)({requestType:"crt.DataGridRowDoubleClickRequest",type:"crt.DataGridRowDoubleClickHandler"})],oe);var he=g(31134);let D=class{};D.\u0275fac=function(e){return new(e||D)},D.\u0275mod=o.\u0275\u0275defineNgModule({type:D}),D.\u0275inj=o.\u0275\u0275defineInjector({imports:[he.CommonModule]}),D=(0,te.__decorate)([(0,c.CrtModule)({requestHandlers:[ie,oe]})],D),function(){(typeof ngJitMode>"u"||ngJitMode)&&o.\u0275\u0275setNgModuleScope(D,{imports:[he.CommonModule]})}()}}]);
