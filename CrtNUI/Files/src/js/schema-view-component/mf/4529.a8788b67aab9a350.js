(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[4529,8239,5036,6118,7344,8160,1034,8056,1906,4501,1216,9256,9795,1006,7571,6025,9424,885],{44529:(F,E,c)=>{c.r(E),c.d(E,{CopilotChatService:()=>m,CopilotModule:()=>M});var l=c(74742),a=c(75378),f=c(29967),r=c(8239),A=c(36780),n=c(21322);let _=class{constructor(e){this._intentSchemaManager=e}convert(e,t,s){var o=this;return(0,r.Z)(function*(){const i=e.map(function(){var y=(0,r.Z)(function*(P){return yield P[s]});return function(P){return y.apply(this,arguments)}}()),u=yield Promise.all(i);return yield(0,n.lastValueFrom)(o._intentSchemaManager.generateActionCode(u))})()}};_=(0,l.__decorate)([(0,a.CrtConverter)({type:"crt.GenerateCopilotActionCode"}),(0,l.__metadata)("design:paramtypes",[A.CopilotIntentManagerService])],_);var v=c(96923),I=c(34038),p=c(97600),g;(function(d){d.Assistant="assistant",d.User="user"})(g||(g={}));class h{static _getAuthorByRole(e,t){return e===g.Assistant?h._getCopilotAuthor():h._getUserAuthor(t)}static _getIsBotMessage(e){return e===g.Assistant}static _getMessageDirection(e){return e===g.User?v.MessageDirection.Outcoming:v.MessageDirection.Incoming}static _getCopilotAuthor(){return{name:"Copilot",photo:h.copilotImg}}static _getUserAuthor(e){return{id:e.id,name:e.name,photoId:e.photoId}}static convertMessages(e,t){return e.filter(s=>(s.role===g.Assistant||s.role===g.User)&&!(0,p.isEmpty)(s.content)).map(s=>{const o={text:s.content,type:I.ChatMessageTypeEnum.Text,date:new Date,isBotMessage:!0,id:s.id};return o.author=h._getAuthorByRole(s.role,t),o.isBotMessage=h._getIsBotMessage(s.role),o.direction=h._getMessageDirection(s.role),o})}}h.copilotImg="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGcgaWQ9Ikljb24gfCBBSSBDb3BpbG90IC0gMTZ4MTYgfCBoZWF2eSI+CjxwYXRoIGlkPSJTdWJ0cmFjdCIgZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0wLjIzNTc2MSA2LjA2NDM0QzAuMDgxNzQxOSA2LjY4NDE2IDAgNy4zMzI1MyAwIDhDMCAxMi40MTgzIDMuNTgxNzIgMTYgOCAxNkMxMC45NjExIDE2IDEzLjU0NjUgMTQuMzkxMiAxNC45Mjk3IDEySDEyLjczNjFDMTEuNTk5IDEzLjM0NSA5Ljg5OTIxIDE0LjE5OTEgOCAxNC4xOTkxQzQuNTc2MzMgMTQuMTk5MSAxLjgwMDg5IDExLjQyMzcgMS44MDA4OSA4QzEuODAwODkgNy42NTM3OSAxLjgyOTI3IDcuMzE0MjEgMS44ODM4MyA2Ljk4MzQ2TDAuMjM1NzYxIDYuMDY0MzRaTTEyLjczNjEgNC4wMDAwMUMxMS41OTkgMi42NTQ5OCA5Ljg5OTIzIDEuODAwODkgOCAxLjgwMDg5QzcuMzM1NjUgMS44MDA4OSA2LjY5NTcxIDEuOTA1NCA2LjA5NTcyIDIuMDk4ODdMMy41Mjg0NyAxLjM2NTM3QzQuODA1MDEgMC41MDMzMjcgNi4zNDM3MyAwIDggMEMxMC45NjExIDAgMTMuNTQ2NSAxLjYwODggMTQuOTI5OCA0LjAwMDAxSDEyLjczNjFaIiBmaWxsPSIjNEY0M0MyIi8+CjxwYXRoIGlkPSJzaGFwZSIgZD0iTTE2IDhMNyAxMS41TDguNSA4TDAgMkwxNiA4WiIgZmlsbD0iIzRGNDNDMiIvPgo8L2c+Cjwvc3ZnPgo=";var L=c(33177);let D=class extends a.BaseRequestHandler{constructor(e){super(),this._customEventService=e}handle(e){var t=this;return(0,r.Z)(function*(){const o=yield e.$context.ProcessDesignerInstanceId;return yield new Promise(i=>{const u={designerInstanceId:o,callback:i};t._customEventService.createOutboundChannel("cancelProcessSchemaChanges").next(u)}),yield t.next?.handle(e)})()}};D=(0,l.__decorate)([(0,a.CrtRequestHandler)({requestType:"crt.CancelRecordChangesRequest",type:"crt.CopilotProcessActionsCancelRecordHandler",scopes:["CopilotProcessActions_FormPage"]}),(0,l.__metadata)("design:paramtypes",[L.CustomEventService])],D);var w=c(77207);let N=class extends a.BaseRequestHandler{constructor(e,t){super(),this._customEventService=e,this._translateService=t}_performDesignerSave(e){var t=this;return(0,r.Z)(function*(){const s=yield e.ProcessDesignerInstanceId;return new Promise(o=>{const i={designerInstanceId:s,saveCallback:o};t._customEventService.createOutboundChannel("saveProcessSchema").next(i)})})()}_showDesignerValidationErrorNotification(e){var t=this;return(0,r.Z)(function*(){const s="Dialog.ProcessSchemaSavedWithValidationError",o=yield(0,n.lastValueFrom)(t._translateService.get(s)),i={type:"crt.NotificationRequest",$context:e,message:o,translate:!1};yield t.handlerChain.process(i)})()}handle(e){var t=this;return(0,r.Z)(function*(){const s=e.$context;if(!(yield s.isValid()))return yield t.next?.handle(e);const i=yield t._performDesignerSave(s);return i.isCanceled?!1:(i.isValid||(yield t._showDesignerValidationErrorNotification(s)),yield t.next?.handle(e))})()}};N=(0,l.__decorate)([(0,a.CrtRequestHandler)({requestType:"crt.SaveRecordRequest",type:"crt.CopilotProcessActionsPageSaveHandler",scopes:["CopilotProcessActions_FormPage"]}),(0,l.__metadata)("design:paramtypes",[L.CustomEventService,w.TranslateService])],N);const S={process:"ProcessSchemaUId",params:"PDS_Params"};function U(d){return T.apply(this,arguments)}function T(){return T=(0,r.Z)(function*(d){const e="ProcessDesignerInstanceId";let t=yield d[e];t||(t=(0,a.generateGuid)(),d[e]=t)}),T.apply(this,arguments)}let j=class extends a.BaseRequestHandler{_subscribeParamsLoaded(e){const t=new n.Subscription;t.add(e.events$.pipe((0,n.filter)(({type:s})=>s==="finish-load-model-attributes"),(0,n.filter)(({payload:s})=>s[S.params]),(0,n.switchMap)(()=>e[S.params]),(0,n.filter)(s=>!!s)).subscribe({next:function(){var s=(0,r.Z)(function*(o){let i;try{i=JSON.parse(o).processSchemaUId}catch(P){console.error(`params = ${o}
${P?.message}`)}const u={silent:!0},y={[S.process]:i};e.setValue(y,u),yield U(e)});return function(i){return s.apply(this,arguments)}}(),complete:()=>{t.unsubscribe()}}))}handle(e){var t=this;return(0,r.Z)(function*(){yield t.next?.handle(e),t._subscribeParamsLoaded(e.$context)})()}};j=(0,l.__decorate)([(0,a.CrtRequestHandler)({type:"crt.CopilotProcessActionsPageInitHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["CopilotProcessActions_FormPage"]})],j);var x=c(49475),Z=c(24709);let H=class extends a.BaseRequestHandler{constructor(){super(...arguments),this._statusFlags=["ProcessSchemaIsChanged","HasUnsavedData",Z.IS_CHANGED_SYSTEM_ATTRIBUTE_NAME,S.process]}_handleProcessChange(e){if(e.attributeName===S.process&&!e.silent){const t={processSchemaUId:e.value};e.$context[S.params]=JSON.stringify(t)}}_handleCreateModel(e){return(0,r.Z)(function*(){e.attributeName===Z.PRIMARY_MODEL_MODE_SYSTEM_ATTRIBUTE_NAME&&e.value===x.ModelMode.Create&&(e.$context[S.process]=a.EMPTY_GUID,yield U(e.$context))})()}handle(e){var t=this;return(0,r.Z)(function*(){if(t._handleProcessChange(e),yield t._handleCreateModel(e),e.attributeName==="ProcessSchemaIsLoaded"&&e.value){const s=yield e.$context.getPrimaryModelName();e.$context.getModelByName(s).setLoadedState()}else if(t._statusFlags.includes(e.attributeName)){const s=yield e.$context[S.process],o=yield e.$context.ProcessSchemaIsLoaded,i=yield e.$context.ProcessSchemaIsChanged,u=yield e.$context.HasUnsavedData,y=yield e.$context.IsChanged;e.$context.ProcessActionHasUnsavedData=o&&s!==a.EMPTY_GUID&&(u||y||i)}return t.next?.handle(e)})()}};H=(0,l.__decorate)([(0,a.CrtRequestHandler)({type:"crt.CopilotProcessActionsPageAttributeChangeHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["CopilotProcessActions_FormPage"]})],H);const B="CopilotChatInitMessagesSubscription";var G=c(2876),Y=c(52045),V=c(27049),C=c(94450);const Q="CopilotMsgChannelSender",W="CopilotChatPart";class m{constructor(e,t,s,o){this._httpClient=e,this._messageChannelService=t,this._contextSchemaService=s,this._featureValues=o,this._apiUrl="/rest/CopilotService",this._copilotSession=null;const i=this._featureValues??{};this._isNeedToAddConsoleLog=Boolean(i.ShowSystemMessagesFromCopilot)}getInitialMessages$(){return this._loadInitialMessages()}copilotMessageEvent$(){return this._messageChannelService.messageEvent$.pipe((0,n.filter)(e=>e.header.sender===Q&&e.header.bodyTypeName===W),(0,n.map)(e=>e.body.messages),(0,n.tap)(e=>{this._isNeedToAddConsoleLog&&(console.group("Copilot"),console.log(e),console.groupEnd())}))}_loadInitialMessages(){return this._getActiveCopilotSessions().pipe((0,n.mergeMap)(e=>this._handleActiveCopilotSessions(e).pipe((0,V.catchError)(t=>(console.error(t),(0,n.of)([]))))))}_handleActiveCopilotSessions(e){return e.length>0?(this._copilotSession=e[0],this._getCopilotSessionMessages(this._copilotSession.id)):(0,n.throwError)(()=>new Error("No active copilot sessions found"))}_getActiveCopilotSessions(){return this._httpClient.post(`${this._apiUrl}/GetActiveCopilotSessions`,{}).pipe((0,n.map)(e=>e.copilotSessions))}_getCopilotSessionMessages(e){return this._httpClient.post(`${this._apiUrl}/GetCopilotSessionMessage`,{copilotSessionId:e}).pipe((0,n.map)(t=>t.copilotMessages))}_sendUserMessage(e){return(0,n.from)(this._contextSchemaService.getContext()).pipe((0,n.switchMap)(t=>this._httpClient.post(`${this._apiUrl}/SendUserMessage`,{content:e,copilotContext:{parts:t||[]},copilotSessionId:this._copilotSession?.id})),(0,n.map)(t=>t?.copilotChatPart))}_closeCopilotSession(){return this._httpClient.post(`${this._apiUrl}/CloseSession`,{copilotSessionId:this._copilotSession?.id}).pipe((0,V.catchError)(e=>(0,n.throwError)(()=>new Error(`Server return status: ${e.status}`))))}sayWithResponse(e){var t=this;return(0,r.Z)(function*(){const s=yield(0,n.firstValueFrom)(t._sendUserMessage(e));return s&&(0,p.isEmpty)(s.errorCode)&&(0,p.isEmpty)(s.errorMessage)&&(t._copilotSession=s.copilotSession),s})()}closeSession(){var e=this;return(0,r.Z)(function*(){if(!e._copilotSession?.id)return Promise.reject("No active session");try{yield(0,n.firstValueFrom)(e._closeCopilotSession()),e._copilotSession=null}catch(t){return Promise.reject(`Server return status: ${t.status}`)}})()}}m.\u0275fac=function(e){return new(e||m)(C.\u0275\u0275inject(G.HttpClient),C.\u0275\u0275inject(x.MessageChannelService),C.\u0275\u0275inject(Y.ContextSchemaService),C.\u0275\u0275inject(x.FEATURE_VALUES,8))},m.\u0275prov=C.\u0275\u0275defineInjectable({token:m,factory:m.\u0275fac,providedIn:"root"});let R=class extends a.BaseRequestHandler{constructor(e,t){super(),this._copilotChatService=e,this._userInfo=t}_getConvertedMessages(e){return h.convertMessages(e,{id:this._userInfo.contactId,name:this._userInfo.contactName,photoId:this._userInfo.photoId})}handle(e){var t=this;return(0,r.Z)(function*(){yield t.next?.handle(e);const s=e.$context;e.$context.ChatMessages=t._getConvertedMessages(yield(0,n.lastValueFrom)(t._copilotChatService.getInitialMessages$())),s[B]=t._copilotChatService.copilotMessageEvent$().subscribe(o=>{const i=t._getConvertedMessages(o);e.$context.ChatMessages=i,e.$context.IsTyping=i.length>0?!i[i.length-1].isBotMessage:!1})})()}};R=(0,l.__decorate)([(0,a.CrtRequestHandler)({type:"crt.CopilotChatInitHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["CopilotPanel"]}),(0,l.__metadata)("design:paramtypes",[m,x.UserInfo])],R);let z=class extends a.BaseRequestHandler{constructor(){super()}handle(e){var t=this;return(0,r.Z)(function*(){const s=e.$context;for(const o of[B])(yield s[o])?.unsubscribe();yield t.next?.handle(e)})()}};z=(0,l.__decorate)([(0,a.CrtRequestHandler)({type:"crt.CopilotChatDestroyHandler",requestType:"crt.HandleViewModelDestroyRequest",scopes:["CopilotPanel"]}),(0,l.__metadata)("design:paramtypes",[])],z);var J=c(99293);let b=class extends a.BaseRequestHandler{constructor(e){super(),this._userInfo=e.get(x.UserInfo),this._copilotChatService=e.get(m),this._notifyService=e.get(J.NotifyService)}_getConvertedMessages(e){return h.convertMessages(e,{id:this._userInfo.contactId,name:this._userInfo.contactName,photoId:this._userInfo.photoId})}_addMessageToConversation(e,t,s){e.$context[s]=this._getConvertedMessages(t)}_onError(){var e=this;return(0,r.Z)(function*(){yield e._notifyService.error({message:"MessageEditor.CommonSendErrorMessage"})})()}_publishMessageToChat(e){var t=this;return(0,r.Z)(function*(){let s;try{s=yield t._copilotChatService.sayWithResponse(e)}catch{t._onError();return}if(s&&(!(0,p.isEmpty)(s.errorCode)||!(0,p.isEmpty)(s.errorMessage))){t._onError();return}return s})()}handle(e){var t=this;return(0,r.Z)(function*(){const s=e.attributesMapping,o=s?.chatInput;if(!(0,p.isEmpty)(o)){const i=yield e.$context[o];e.$context[o]="";const u=yield t._publishMessageToChat(i);if(!u)e.$context[o]=i;else if(u?.messages.length){const y=s?.chatMessages;(0,p.isEmpty)(y)||t._addMessageToConversation(e,u.messages,y)}}yield t.next?.handle(e)})()}};b=(0,l.__decorate)([(0,a.CrtRequestHandler)({type:"crt.CopilotMessageEditorSendHandler",requestType:"crt.MessageEditorSendRequest",scopes:["CopilotPanel"]}),(0,l.__metadata)("design:paramtypes",[C.Injector])],b);let O=class extends a.BaseRequestHandler{constructor(e){super(),this._copilotChatService=e.get(m)}handle(e){var t=this;return(0,r.Z)(function*(){yield t._copilotChatService.closeSession();const s=e.chatMessagesAttributeName,o=e.conversationEventAttributeName;!(0,p.isEmpty)(s)&&!(0,p.isEmpty)(o)&&(e.$context[s]=[],e.$context[o]=[{name:I.CONVERSATION_RESET_EVENT}]),yield t.next?.handle(e)})()}};O=(0,l.__decorate)([(0,a.CrtRequestHandler)({type:"crt.CopilotRestartSessionHandler",requestType:"crt.CopilotRestartSessionRequest",scopes:["CopilotPanel"]}),(0,l.__metadata)("design:paramtypes",[C.Injector])],O);let $=class extends a.BaseRequestHandler{constructor(e){super(),this.injector=e,this._intentManager=this.injector.get(A.CopilotIntentManagerService)}_getModelInitConfig(e){return(0,r.Z)(function*(){const t=e.modelInitConfigs,s=yield e.getPrimaryModelName();return t?.find(o=>o.name===s)})()}_getIntent(e,t){var s=this;return(0,r.Z)(function*(){let o;const u=(yield e.getPrimaryDataSchema())?.name;return u==="CopilotIntent"?o=yield(0,n.firstValueFrom)(s._intentManager.getIntent(t)):u==="CopilotAction"&&(o=yield(0,n.firstValueFrom)(s._intentManager.getIntentByActionUId(t))),o})()}_disableCodeField(e){const t=e.getAttributeNameByViewItemName("Code");e.disableAttributeValidator(t,"CodePrefixValidator"),e.setAttributePropertyValue(t,"readonly",!0)}handle(e){var t=this;return(0,r.Z)(function*(){yield t.next?.handle(e);const s=e.$context,o=yield t._getModelInitConfig(s);if(!(o?.action===a.ModelInPageAction.Edit))return;(yield t._getIntent(s,o?.recordId))?.ExtendParent&&t._disableCodeField(s)})()}};$=(0,l.__decorate)([(0,a.CrtRequestHandler)({type:"crt.CopilotPageDisableCodeFieldHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["CopilotIntents_FormPage","CopilotProcessActions_FormPage"]}),(0,l.__metadata)("design:paramtypes",[C.Injector])],$);let M=class{};M.\u0275fac=function(e){return new(e||M)},M.\u0275mod=C.\u0275\u0275defineNgModule({type:M}),M.\u0275inj=C.\u0275\u0275defineInjector({imports:[f.CopilotIntentSchemaDesignerApiModule]}),M=(0,l.__decorate)([(0,a.CrtModule)({viewElements:[],requestHandlers:[b,R,D,N,j,H,O,$],converters:[_]})],M),function(){(typeof ngJitMode>"u"||ngJitMode)&&C.\u0275\u0275setNgModuleScope(M,{imports:[f.CopilotIntentSchemaDesignerApiModule]})}()},8239:(F,E,c)=>{c.d(E,{Z:()=>a});function l(f,r,A,n,_,v,I){try{var p=f[v](I),g=p.value}catch(h){A(h);return}p.done?r(g):Promise.resolve(g).then(n,_)}function a(f){return function(){var r=this,A=arguments;return new Promise(function(n,_){var v=f.apply(r,A);function I(g){l(v,n,_,I,p,"next",g)}function p(g){l(v,n,_,I,p,"throw",g)}I(void 0)})}}}}]);
