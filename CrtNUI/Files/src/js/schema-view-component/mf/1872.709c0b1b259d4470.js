(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[1872,9967],{44529:(J,H,c)=>{c.r(H),c.d(H,{CopilotChatService:()=>C,CopilotModule:()=>m});var d=c(74742),i=c(75378),R=c(29967),r=c(8239),b=c(36780),a=c(21322);let v=class{constructor(e){this._intentSchemaManager=e}convert(e,t,s){var o=this;return(0,r.Z)(function*(){const n=e.map(function(){var _=(0,r.Z)(function*(y){return yield y[s]});return function(y){return _.apply(this,arguments)}}()),p=yield Promise.all(n);return yield(0,a.lastValueFrom)(o._intentSchemaManager.generateActionCode(p))})()}};v=(0,d.__decorate)([(0,i.CrtConverter)({type:"crt.GenerateCopilotActionCode"}),(0,d.__metadata)("design:paramtypes",[b.CopilotIntentManagerService])],v);var O=c(96923),$=c(34038),h=c(97600),I;(function(l){l.Assistant="assistant",l.User="user"})(I||(I={}));class u{static _getAuthorByRole(e,t){return e===I.Assistant?u._getCopilotAuthor():u._getUserAuthor(t)}static _getIsBotMessage(e){return e===I.Assistant}static _getMessageDirection(e){return e===I.User?O.MessageDirection.Outcoming:O.MessageDirection.Incoming}static _getCopilotAuthor(){return{name:"Copilot",photo:u.copilotImg}}static _getUserAuthor(e){return{id:e.id,name:e.name,photoId:e.photoId}}static convertMessages(e,t){return e.filter(s=>(s.role===I.Assistant||s.role===I.User)&&!(0,h.isEmpty)(s.content)).map(s=>{const o={text:s.content,type:$.ChatMessageTypeEnum.Text,date:new Date,isBotMessage:!0,id:s.id};return o.author=u._getAuthorByRole(s.role,t),o.isBotMessage=u._getIsBotMessage(s.role),o.direction=u._getMessageDirection(s.role),o})}}u.copilotImg="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGcgaWQ9Ikljb24gfCBBSSBDb3BpbG90IC0gMTZ4MTYgfCBoZWF2eSI+CjxwYXRoIGlkPSJTdWJ0cmFjdCIgZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0wLjIzNTc2MSA2LjA2NDM0QzAuMDgxNzQxOSA2LjY4NDE2IDAgNy4zMzI1MyAwIDhDMCAxMi40MTgzIDMuNTgxNzIgMTYgOCAxNkMxMC45NjExIDE2IDEzLjU0NjUgMTQuMzkxMiAxNC45Mjk3IDEySDEyLjczNjFDMTEuNTk5IDEzLjM0NSA5Ljg5OTIxIDE0LjE5OTEgOCAxNC4xOTkxQzQuNTc2MzMgMTQuMTk5MSAxLjgwMDg5IDExLjQyMzcgMS44MDA4OSA4QzEuODAwODkgNy42NTM3OSAxLjgyOTI3IDcuMzE0MjEgMS44ODM4MyA2Ljk4MzQ2TDAuMjM1NzYxIDYuMDY0MzRaTTEyLjczNjEgNC4wMDAwMUMxMS41OTkgMi42NTQ5OCA5Ljg5OTIzIDEuODAwODkgOCAxLjgwMDg5QzcuMzM1NjUgMS44MDA4OSA2LjY5NTcxIDEuOTA1NCA2LjA5NTcyIDIuMDk4ODdMMy41Mjg0NyAxLjM2NTM3QzQuODA1MDEgMC41MDMzMjcgNi4zNDM3MyAwIDggMEMxMC45NjExIDAgMTMuNTQ2NSAxLjYwODggMTQuOTI5OCA0LjAwMDAxSDEyLjczNjFaIiBmaWxsPSIjNEY0M0MyIi8+CjxwYXRoIGlkPSJzaGFwZSIgZD0iTTE2IDhMNyAxMS41TDguNSA4TDAgMkwxNiA4WiIgZmlsbD0iIzRGNDNDMiIvPgo8L2c+Cjwvc3ZnPgo=";var L=c(33177);let f=class extends i.BaseRequestHandler{constructor(e){super(),this._customEventService=e}handle(e){var t=this;return(0,r.Z)(function*(){const o=yield e.$context.ProcessDesignerInstanceId;return yield new Promise(n=>{const p={designerInstanceId:o,callback:n};t._customEventService.createOutboundChannel("cancelProcessSchemaChanges").next(p)}),yield t.next?.handle(e)})()}};f=(0,d.__decorate)([(0,i.CrtRequestHandler)({requestType:"crt.CancelRecordChangesRequest",type:"crt.CopilotProcessActionsCancelRecordHandler",scopes:["CopilotProcessActions_FormPage"]}),(0,d.__metadata)("design:paramtypes",[L.CustomEventService])],f);var F=c(77207);let A=class extends i.BaseRequestHandler{constructor(e,t){super(),this._customEventService=e,this._translateService=t}_performDesignerSave(e){var t=this;return(0,r.Z)(function*(){const s=yield e.ProcessDesignerInstanceId;return new Promise(o=>{const n={designerInstanceId:s,saveCallback:o};t._customEventService.createOutboundChannel("saveProcessSchema").next(n)})})()}_showDesignerValidationErrorNotification(e){var t=this;return(0,r.Z)(function*(){const s="Dialog.ProcessSchemaSavedWithValidationError",o=yield(0,a.lastValueFrom)(t._translateService.get(s)),n={type:"crt.NotificationRequest",$context:e,message:o,translate:!1};yield t.handlerChain.process(n)})()}handle(e){var t=this;return(0,r.Z)(function*(){const s=e.$context;if(!(yield s.isValid()))return yield t.next?.handle(e);const n=yield t._performDesignerSave(s);return n.isCanceled?!1:(n.isValid||(yield t._showDesignerValidationErrorNotification(s)),yield t.next?.handle(e))})()}};A=(0,d.__decorate)([(0,i.CrtRequestHandler)({requestType:"crt.SaveRecordRequest",type:"crt.CopilotProcessActionsPageSaveHandler",scopes:["CopilotProcessActions_FormPage"]}),(0,d.__metadata)("design:paramtypes",[L.CustomEventService,F.TranslateService])],A);const M={process:"ProcessSchemaUId",params:"PDS_Params"};function U(l){return x.apply(this,arguments)}function x(){return x=(0,r.Z)(function*(l){const e="ProcessDesignerInstanceId";let t=yield l[e];t||(t=(0,i.generateGuid)(),l[e]=t)}),x.apply(this,arguments)}let E=class extends i.BaseRequestHandler{_subscribeParamsLoaded(e){const t=new a.Subscription;t.add(e.events$.pipe((0,a.filter)(({type:s})=>s==="finish-load-model-attributes"),(0,a.filter)(({payload:s})=>s[M.params]),(0,a.switchMap)(()=>e[M.params]),(0,a.filter)(s=>!!s)).subscribe({next:function(){var s=(0,r.Z)(function*(o){let n;try{n=JSON.parse(o).processSchemaUId}catch(y){console.error(`params = ${o}
${y?.message}`)}const p={silent:!0},_={[M.process]:n};e.setValue(_,p),yield U(e)});return function(n){return s.apply(this,arguments)}}(),complete:()=>{t.unsubscribe()}}))}handle(e){var t=this;return(0,r.Z)(function*(){yield t.next?.handle(e),t._subscribeParamsLoaded(e.$context)})()}};E=(0,d.__decorate)([(0,i.CrtRequestHandler)({type:"crt.CopilotProcessActionsPageInitHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["CopilotProcessActions_FormPage"]})],E);var S=c(49475),Z=c(24709);let D=class extends i.BaseRequestHandler{constructor(){super(...arguments),this._statusFlags=["ProcessSchemaIsChanged","HasUnsavedData",Z.IS_CHANGED_SYSTEM_ATTRIBUTE_NAME,M.process]}_handleProcessChange(e){if(e.attributeName===M.process&&!e.silent){const t={processSchemaUId:e.value};e.$context[M.params]=JSON.stringify(t)}}_handleCreateModel(e){return(0,r.Z)(function*(){e.attributeName===Z.PRIMARY_MODEL_MODE_SYSTEM_ATTRIBUTE_NAME&&e.value===S.ModelMode.Create&&(e.$context[M.process]=i.EMPTY_GUID,yield U(e.$context))})()}handle(e){var t=this;return(0,r.Z)(function*(){if(t._handleProcessChange(e),yield t._handleCreateModel(e),e.attributeName==="ProcessSchemaIsLoaded"&&e.value){const s=yield e.$context.getPrimaryModelName();e.$context.getModelByName(s).setLoadedState()}else if(t._statusFlags.includes(e.attributeName)){const s=yield e.$context[M.process],o=yield e.$context.ProcessSchemaIsLoaded,n=yield e.$context.ProcessSchemaIsChanged,p=yield e.$context.HasUnsavedData,_=yield e.$context.IsChanged;e.$context.ProcessActionHasUnsavedData=o&&s!==i.EMPTY_GUID&&(p||_||n)}return t.next?.handle(e)})()}};D=(0,d.__decorate)([(0,i.CrtRequestHandler)({type:"crt.CopilotProcessActionsPageAttributeChangeHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["CopilotProcessActions_FormPage"]})],D);const B="CopilotChatInitMessagesSubscription";var w=c(2876),G=c(52045),V=c(27049),g=c(94450);const Y="CopilotMsgChannelSender",Q="CopilotChatPart";class C{constructor(e,t,s,o){this._httpClient=e,this._messageChannelService=t,this._contextSchemaService=s,this._featureValues=o,this._apiUrl="/rest/CopilotService",this._copilotSession=null;const n=this._featureValues??{};this._isNeedToAddConsoleLog=Boolean(n.ShowSystemMessagesFromCopilot)}getInitialMessages$(){return this._loadInitialMessages()}copilotMessageEvent$(){return this._messageChannelService.messageEvent$.pipe((0,a.filter)(e=>e.header.sender===Y&&e.header.bodyTypeName===Q),(0,a.map)(e=>e.body.messages),(0,a.tap)(e=>{this._isNeedToAddConsoleLog&&(console.group("Copilot"),console.log(e),console.groupEnd())}))}_loadInitialMessages(){return this._getActiveCopilotSessions().pipe((0,a.mergeMap)(e=>this._handleActiveCopilotSessions(e).pipe((0,V.catchError)(t=>(console.error(t),(0,a.of)([]))))))}_handleActiveCopilotSessions(e){return e.length>0?(this._copilotSession=e[0],this._getCopilotSessionMessages(this._copilotSession.id)):(0,a.throwError)(()=>new Error("No active copilot sessions found"))}_getActiveCopilotSessions(){return this._httpClient.post(`${this._apiUrl}/GetActiveCopilotSessions`,{}).pipe((0,a.map)(e=>e.copilotSessions))}_getCopilotSessionMessages(e){return this._httpClient.post(`${this._apiUrl}/GetCopilotSessionMessage`,{copilotSessionId:e}).pipe((0,a.map)(t=>t.copilotMessages))}_sendUserMessage(e){return(0,a.from)(this._contextSchemaService.getContext()).pipe((0,a.switchMap)(t=>this._httpClient.post(`${this._apiUrl}/SendUserMessage`,{content:e,copilotContext:{parts:t||[]},copilotSessionId:this._copilotSession?.id})),(0,a.map)(t=>t?.copilotChatPart))}_closeCopilotSession(){return this._httpClient.post(`${this._apiUrl}/CloseSession`,{copilotSessionId:this._copilotSession?.id}).pipe((0,V.catchError)(e=>(0,a.throwError)(()=>new Error(`Server return status: ${e.status}`))))}sayWithResponse(e){var t=this;return(0,r.Z)(function*(){const s=yield(0,a.firstValueFrom)(t._sendUserMessage(e));return s&&(0,h.isEmpty)(s.errorCode)&&(0,h.isEmpty)(s.errorMessage)&&(t._copilotSession=s.copilotSession),s})()}closeSession(){var e=this;return(0,r.Z)(function*(){if(!e._copilotSession?.id)return Promise.reject("No active session");try{yield(0,a.firstValueFrom)(e._closeCopilotSession()),e._copilotSession=null}catch(t){return Promise.reject(`Server return status: ${t.status}`)}})()}}C.\u0275fac=function(e){return new(e||C)(g.\u0275\u0275inject(w.HttpClient),g.\u0275\u0275inject(S.MessageChannelService),g.\u0275\u0275inject(G.ContextSchemaService),g.\u0275\u0275inject(S.FEATURE_VALUES,8))},C.\u0275prov=g.\u0275\u0275defineInjectable({token:C,factory:C.\u0275fac,providedIn:"root"});let P=class extends i.BaseRequestHandler{constructor(e,t){super(),this._copilotChatService=e,this._userInfo=t}_getConvertedMessages(e){return u.convertMessages(e,{id:this._userInfo.contactId,name:this._userInfo.contactName,photoId:this._userInfo.photoId})}handle(e){var t=this;return(0,r.Z)(function*(){yield t.next?.handle(e);const s=e.$context;e.$context.ChatMessages=t._getConvertedMessages(yield(0,a.lastValueFrom)(t._copilotChatService.getInitialMessages$())),s[B]=t._copilotChatService.copilotMessageEvent$().subscribe(o=>{const n=t._getConvertedMessages(o);e.$context.ChatMessages=n,e.$context.IsTyping=n.length>0?!n[n.length-1].isBotMessage:!1})})()}};P=(0,d.__decorate)([(0,i.CrtRequestHandler)({type:"crt.CopilotChatInitHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["CopilotPanel"]}),(0,d.__metadata)("design:paramtypes",[C,S.UserInfo])],P);let z=class extends i.BaseRequestHandler{constructor(){super()}handle(e){var t=this;return(0,r.Z)(function*(){const s=e.$context;for(const o of[B])(yield s[o])?.unsubscribe();yield t.next?.handle(e)})()}};z=(0,d.__decorate)([(0,i.CrtRequestHandler)({type:"crt.CopilotChatDestroyHandler",requestType:"crt.HandleViewModelDestroyRequest",scopes:["CopilotPanel"]}),(0,d.__metadata)("design:paramtypes",[])],z);var W=c(99293);let N=class extends i.BaseRequestHandler{constructor(e){super(),this._userInfo=e.get(S.UserInfo),this._copilotChatService=e.get(C),this._notifyService=e.get(W.NotifyService)}_getConvertedMessages(e){return u.convertMessages(e,{id:this._userInfo.contactId,name:this._userInfo.contactName,photoId:this._userInfo.photoId})}_addMessageToConversation(e,t,s){e.$context[s]=this._getConvertedMessages(t)}_onError(){var e=this;return(0,r.Z)(function*(){yield e._notifyService.error({message:"MessageEditor.CommonSendErrorMessage"})})()}_publishMessageToChat(e){var t=this;return(0,r.Z)(function*(){let s;try{s=yield t._copilotChatService.sayWithResponse(e)}catch{t._onError();return}if(s&&(!(0,h.isEmpty)(s.errorCode)||!(0,h.isEmpty)(s.errorMessage))){t._onError();return}return s})()}handle(e){var t=this;return(0,r.Z)(function*(){const s=e.attributesMapping,o=s?.chatInput;if(!(0,h.isEmpty)(o)){const n=yield e.$context[o];e.$context[o]="";const p=yield t._publishMessageToChat(n);if(!p)e.$context[o]=n;else if(p?.messages.length){const _=s?.chatMessages;(0,h.isEmpty)(_)||t._addMessageToConversation(e,p.messages,_)}}yield t.next?.handle(e)})()}};N=(0,d.__decorate)([(0,i.CrtRequestHandler)({type:"crt.CopilotMessageEditorSendHandler",requestType:"crt.MessageEditorSendRequest",scopes:["CopilotPanel"]}),(0,d.__metadata)("design:paramtypes",[g.Injector])],N);let T=class extends i.BaseRequestHandler{constructor(e){super(),this._copilotChatService=e.get(C)}handle(e){var t=this;return(0,r.Z)(function*(){yield t._copilotChatService.closeSession();const s=e.chatMessagesAttributeName,o=e.conversationEventAttributeName;!(0,h.isEmpty)(s)&&!(0,h.isEmpty)(o)&&(e.$context[s]=[],e.$context[o]=[{name:$.CONVERSATION_RESET_EVENT}]),yield t.next?.handle(e)})()}};T=(0,d.__decorate)([(0,i.CrtRequestHandler)({type:"crt.CopilotRestartSessionHandler",requestType:"crt.CopilotRestartSessionRequest",scopes:["CopilotPanel"]}),(0,d.__metadata)("design:paramtypes",[g.Injector])],T);let j=class extends i.BaseRequestHandler{constructor(e){super(),this.injector=e,this._intentManager=this.injector.get(b.CopilotIntentManagerService)}_getModelInitConfig(e){return(0,r.Z)(function*(){const t=e.modelInitConfigs,s=yield e.getPrimaryModelName();return t?.find(o=>o.name===s)})()}_getIntent(e,t){var s=this;return(0,r.Z)(function*(){let o;const p=(yield e.getPrimaryDataSchema())?.name;return p==="CopilotIntent"?o=yield(0,a.firstValueFrom)(s._intentManager.getIntent(t)):p==="CopilotAction"&&(o=yield(0,a.firstValueFrom)(s._intentManager.getIntentByActionUId(t))),o})()}_disableCodeField(e){const t=e.getAttributeNameByViewItemName("Code");e.disableAttributeValidator(t,"CodePrefixValidator"),e.setAttributePropertyValue(t,"readonly",!0)}handle(e){var t=this;return(0,r.Z)(function*(){yield t.next?.handle(e);const s=e.$context,o=yield t._getModelInitConfig(s);if(!(o?.action===i.ModelInPageAction.Edit))return;(yield t._getIntent(s,o?.recordId))?.ExtendParent&&t._disableCodeField(s)})()}};j=(0,d.__decorate)([(0,i.CrtRequestHandler)({type:"crt.CopilotPageDisableCodeFieldHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["CopilotIntents_FormPage","CopilotProcessActions_FormPage"]}),(0,d.__metadata)("design:paramtypes",[g.Injector])],j);let m=class{};m.\u0275fac=function(e){return new(e||m)},m.\u0275mod=g.\u0275\u0275defineNgModule({type:m}),m.\u0275inj=g.\u0275\u0275defineInjector({imports:[R.CopilotIntentSchemaDesignerApiModule]}),m=(0,d.__decorate)([(0,i.CrtModule)({viewElements:[],requestHandlers:[N,P,f,A,E,D,T,j],converters:[v]})],m),function(){(typeof ngJitMode>"u"||ngJitMode)&&g.\u0275\u0275setNgModuleScope(m,{imports:[R.CopilotIntentSchemaDesignerApiModule]})}()}}]);
