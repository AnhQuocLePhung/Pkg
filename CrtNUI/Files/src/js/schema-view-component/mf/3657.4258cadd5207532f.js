(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[3657,7070],{3657:(N,S,c)=>{c.r(S),c.d(S,{CopilotIntentSchemaDesignerApiModule:()=>p});var v=c(74742),C=c(31134),i=c(94450),I=c(75378),u=c(98956),l=c(49475),g=c(36780),f=c(41307),s=c(21322);class y extends u.BaseSchema{}class A{constructor(){this.caption=new l.LocalizableStringArray,this.description=new l.LocalizableStringArray}}class m extends u.BaseSchemaConverterService{constructor(e){super(y),this._userInfo=e,this._sysCultureName=this._userInfo.cultureInfo.sysCultureName}_convertSchemaActionToDto(e,t){return t.actions?.map(n=>({Id:n.uid,Code:n.name,Intent:e,ActionType:n.actionSchemaTypeUId,Name:n.caption?.getValue(this._sysCultureName),Description:n.description?.getValue(this._sysCultureName),Params:n.params}))}_convertDtoActionToSchema(e,t){const n=e.actions||[],_=t.filter(r=>n.every(o=>o.uid!==r.Id)).map(r=>{const o=new A;return o.uid=r.Id,o.name=r.Code,o.params=r.Params,o.actionSchemaTypeUId=r.ActionType,o.caption.setValueLocalizableString(this._sysCultureName,r.Name),o.description.setValueLocalizableString(this._sysCultureName,r.Description),o}),T=n.filter(r=>t.some(o=>o.Id===r.uid)).map(r=>{const o=t.find(D=>D.Id===r.uid);return r.name=o.Code,r.caption.setValueLocalizableString(this._sysCultureName,o.Name),r.description.setValueLocalizableString(this._sysCultureName,o.Description),r.params=o.Params,r.actionSchemaTypeUId=o.ActionType,r});e.actions=[..._,...T]}createSchema(e){const t=super.createSchema(e);return t.caption=new l.LocalizableStringArray(e.caption),t.description=new l.LocalizableStringArray(e.description),t.actions=e.actions?.map(n=>(n.description=new l.LocalizableStringArray(n.description),n.caption=new l.LocalizableStringArray(n.caption),n)),t}convertToSchema(e){return this.createSchema(e)}mapModelToSchema(e,t){return e.prompt=t.Prompt,e.description.setValueLocalizableString(this._sysCultureName,t.Description),e.caption.setValueLocalizableString(this._sysCultureName,t.Title),e.name=t.Code,e.status=t.Status,this._convertDtoActionToSchema(e,t.Actions),e}schemaToModel(e,t){return{UId:e,Title:t.caption.getValue(this._sysCultureName),Code:t.name,Description:t.description.getValue(this._sysCultureName),Prompt:t.prompt,Status:t.status,Actions:this._convertSchemaActionToDto(e,t),ExtendParent:t.extendParent}}}m.\u0275fac=function(e){return new(e||m)(i.\u0275\u0275inject(l.UserInfo))},m.\u0275prov=i.\u0275\u0275defineInjectable({token:m,factory:m.\u0275fac});class h extends u.BaseDesignerApiService{constructor(e){super(e)}}h.\u0275fac=function(e){return new(e||h)(i.\u0275\u0275inject(i.Injector))},h.\u0275prov=i.\u0275\u0275defineInjectable({token:h,factory:h.\u0275fac});class d extends f.BaseCachedService{constructor(){super(...arguments),this._apiService=(0,i.inject)(h),this._convertor=(0,i.inject)(m),this._currentPackageService=(0,i.inject)(u.CurrentPackageApiService)}_normalizeUId(e){return e.toLocaleLowerCase()}_getIntentSchema(e){return this._apiService.getSchema({schemaUId:e,useFullHierarchy:!0}).pipe((0,s.map)(t=>{if(!t.success)throw new Error(t.errorInfo?.message||`Failed to get schema with UId: ${e}`);return t.schema}),(0,s.shareReplay)({bufferSize:1,refCount:!1}),(0,s.catchError)(t=>(0,s.throwError)(()=>t)))}setToCache(e,t){super.setToCache(this._normalizeUId(e),t)}getFromCache(e){return super.getFromCache(this._normalizeUId(e))}get(e){let t=this.getFromCache(e);return t||(t=this._getIntentSchema(e),this.setToCache(e,t)),t.pipe((0,s.map)(n=>this._convertor.schemaToModel(e,n)))}update(e){return this.getFromCache(e.UId).pipe((0,s.map)(t=>this._convertor.mapModelToSchema(t,e)),(0,s.switchMap)(t=>this._apiService.saveSchema(t)))}create(e){return this._currentPackageService.getDesignPackageUId(null).pipe((0,s.switchMap)(t=>this._apiService.createSchema({packageUId:t.uId,extendParent:!1,schemaUId:e})),(0,s.map)(t=>t.schema),(0,s.tap)(t=>this.setToCache(e,(0,s.of)(t))),(0,s.map)(t=>this._convertor.schemaToModel(e,t)))}}d.\u0275fac=function(){let a;return function(t){return(a||(a=i.\u0275\u0275getInheritedFactory(d)))(t||d)}}(),d.\u0275prov=i.\u0275\u0275defineInjectable({token:d,factory:d.\u0275fac});let p=class{};p.\u0275fac=function(e){return new(e||p)},p.\u0275mod=i.\u0275\u0275defineNgModule({type:p}),p.\u0275inj=i.\u0275\u0275defineInjector({providers:[{provide:g.COPILOT_INTENT_REPOSITORY_TOKEN,useClass:d},{provide:h,useFactory:a=>{const e=i.Injector.create({name:"CopilotIntentSchemaDesignerApiInjector",parent:a,providers:[(0,u.getSchemaDesignerApiUrlProvider)("CopilotIntentSchemaDesignerService.svc"),{provide:u.SCHEMA_DESIGNER_CONVERTER,useClass:m,deps:[l.UserInfo]}]});return new h(e)},deps:[i.Injector]},m],imports:[C.CommonModule,u.SchemaDesignerApiModule]}),p=(0,v.__decorate)([(0,I.CrtModule)({})],p),function(){(typeof ngJitMode>"u"||ngJitMode)&&i.\u0275\u0275setNgModuleScope(p,{imports:[C.CommonModule,u.SchemaDesignerApiModule]})}()}}]);
