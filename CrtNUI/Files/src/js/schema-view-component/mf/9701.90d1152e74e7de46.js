(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[9701,8239,5036,6118,7344,8160,1034,8056,1906,4501,1216,9256,9795,1006,7571,6025,9424,885],{79701:(ns,re,f)=>{f.r(re),f.d(re,{ApplicabilityType:()=>ue,BaseBusinessRuleDesignAction:()=>ae,BaseBusinessRuleDesignCondition:()=>P,BusinessRuleAttributeDesignExpression:()=>D,BusinessRuleContextExpression:()=>Le,BusinessRuleDesign:()=>pe,BusinessRuleDesignAction:()=>N,BusinessRuleDesignActionFactory:()=>C,BusinessRuleDesignCase:()=>ie,BusinessRuleDesignCondition:()=>se,BusinessRuleDesignConditionFactory:()=>He,BusinessRuleDesignEmptyCondition:()=>O,BusinessRuleDesignExpression:()=>m,BusinessRuleDesignExpressionFactory:()=>T,BusinessRuleDesignTrigger:()=>ne,BusinessRuleEditableElementDesignAction:()=>q,BusinessRuleEmptyValueDesignExpression:()=>Pe,BusinessRuleFieldSelectionElementDesignAction:()=>w,BusinessRuleFilterLookupAction:()=>$,BusinessRuleFilterLookupDesignExpression:()=>W,BusinessRuleFilterValueDesignExpression:()=>Fe,BusinessRuleFormulaDesignExpression:()=>je,BusinessRuleFormulaExpressionParameterMapping:()=>ce,BusinessRuleGroupDesignCondition:()=>te,BusinessRuleHideElementDesignAction:()=>z,BusinessRuleOptionalElementDesignAction:()=>H,BusinessRulePropertiesPanelService:()=>L,BusinessRuleReadOnlyElementDesignAction:()=>Z,BusinessRuleRequiredElementDesignAction:()=>J,BusinessRuleSetFilterAction:()=>K,BusinessRuleSetPropertyDesignAction:()=>We,BusinessRuleSetValueDesignAction:()=>X,BusinessRuleSetValueItem:()=>Y,BusinessRuleSetValuesDesignAction:()=>Q,BusinessRuleShowElementDesignAction:()=>ee,BusinessRuleSysSettingDesignExpression:()=>Ve,BusinessRuleSysValueDesignExpression:()=>we,BusinessRuleValueDesignExpression:()=>G,BusinessRulesApplier:()=>F,BusinessRulesConditionExecutor:()=>S,BusinessRulesEngine:()=>v,BusinessRulesFilterLookupActionApplier:()=>xe,BusinessRulesModule:()=>k,BusinessRulesSetFilterActionApplier:()=>Ee,BusinessRulesSetPropertyActionApplier:()=>oe,BusinessRulesSetReadonlyPropertyActionApplier:()=>Be,BusinessRulesSetRequiredPropertyActionApplier:()=>_e,BusinessRulesSetValueActionApplier:()=>de,BusinessRulesSetVisibilityPropertyActionApplier:()=>Ae,BusinessRulesTriggerExecutor:()=>I,ScopeStateType:()=>M,ScopeType:()=>y,TestBusinessRuleDesignAction:()=>he,businessRuleEditableElementTypeName:()=>$e,businessRuleOptionalElementTypeName:()=>be,businessRuleReadonlyElementTypeName:()=>ze,businessRuleRequiredElementTypeName:()=>Ce,canToggleAttribute:()=>As,generateBusinessRuleName:()=>Rs});var d=f(74742),o=f(75378),l=f(49475),U=f(75357),u=f(21322),h=f(94450);class g{constructor(e){this._injector=e}static register(e,s){g._actionAppliers.set(e,s)}get(e){const s=g._actionAppliers.get(e.typeName);if(!s)throw new Error(`Business rule applier for change type ${e.typeName} not found.`);return new s(e,this._injector)}}g._actionAppliers=new Map,g.\u0275fac=function(e){return new(e||g)(h.\u0275\u0275inject(h.Injector))},g.\u0275prov=h.\u0275\u0275defineInjectable({token:g,factory:g.\u0275fac});function x(i){return function(e){(0,o.checkTypeNameFormat)(i.type,"BusinessRulesActionApplierTypeName"),(0,o.checkCrtTypeNamePascalCase)(i.type),g.register(i.type,e)}}var y;(function(i){i.Model="Model",i.ViewModel="ViewModel"})(y||(y={}));var M;(function(i){i.Unknown="Unknown",i.Init="Init",i.Create="Create",i.Copy="Copy",i.Update="Update"})(M||(M={}));class E{constructor(e,s){this.action=e,this.injector=s}_logError(e){return console.error("Error when applying business rule",this.action),console.error(e),(0,u.of)(null)}apply(e,s){let t;try{t=this.innerApply(e,s)}catch(r){return this._logError(r)}return t.pipe((0,u.catchError)(r=>this._logError(r)))}}var _=f(8239);class Oe{static _getPrimaryDisplayAttributeName(e){return(0,_.Z)(function*(){return(yield e.getSchema()).primaryDisplayAttributeName})()}static getLookupValue(e,s){var t=this;return(0,_.Z)(function*(){const r=yield o.Model.create(e),n=yield r.getSchema(),a=[n.primaryAttributeName,n.primaryDisplayAttributeName];n.primaryColorAttributeName&&a.push(n.primaryColorAttributeName);const p=yield r.load({parameters:[{type:o.ModelParameterType.PrimaryColumnValue,value:s}],attributes:a});if(!p||p.length===0)throw new Error(`Can't find value for '${s}'`);if(p.length>1)throw new Error(`Load more than 1 data row for '${s}'`);const c=p[0],A=yield t._getPrimaryDisplayAttributeName(r),B={value:s,displayValue:c[A]};return n.primaryColorAttributeName&&(B.primaryColorValue=c[n.primaryColorAttributeName]),B})()}}let de=class extends E{_getValue(e){const s=e.value,t=s.value;if(t==null)return(0,u.of)(t);const r=s.dataValueTypeName,a=Object.values(l.DataValueTypeItems).find(c=>c.name===r)?.type??o.DataValueType.Text,p=(0,l.parseJsonValue)(t,a);return a===o.DataValueType.Lookup?(0,u.from)(Oe.getLookupValue(s.referenceSchemaName,s.value)):(0,u.of)(p)}_setValue(e,s,t){const r=this.action.path,n=e.getViewModelAttributePath(s,r);if(n){if(typeof t=="string"&&t.includes("PowerFx")){const a=JSON.parse(t);a.parameters.forEach(c=>{const A=e.getViewModelAttributePath(s,c.value);c.value=e.attributes[A]});const p=this.injector.get(U.ExpressionEngine);return(0,u.from)(p.execute(a)).pipe((0,u.mergeMap)(c=>e.setValue({[n]:c?.result})))}return e.setValue({[n]:t})}return e.setModelValues(s,{[r]:t})}innerApply(e,s){const t=this.action,r=t.value;return t.skip===!0?(0,u.of)(null):this._getValue(t).pipe((0,u.switchMap)(n=>{if(s.type===y.Model)return this._setValue(e,s.id,n);if(r.scope)return this._setValue(e,r.scope,n);const a=e.getAttributeNameByViewItemName(t.path);return a?e.setValue({[a]:n}):e.setValue({[t.path]:n})}))}};de=(0,d.__decorate)([x({type:"crt.SetValue"})],de);class oe extends E{_getAttributeNames(e,s,t){if(s.type===y.Model)return e.getViewModelAttributePaths(s.id,t);let r=e.getAttributeNameByViewItemName(t);return r||(r=(0,l.generatePropertiesAttributeName)(t)),[r]}setAttributePropertyValue(e,s,t){e.setAttributePropertyValue(s,this.propertyName,t)}resetAttributePropertyValue(e,s){e.resetAttributePropertyValue(s,this.propertyName)}innerApply(e,s){const t=this.action.path;if(!t)return(0,u.of)(!0);const n=t.split(":")[0],a=this._getAttributeNames(e,s,n);return a&&a.forEach(p=>{this.action.resetToDefault?this.resetAttributePropertyValue(e,p):this.setAttributePropertyValue(e,p,this.action.value)}),(0,u.of)(!0)}}function qe(i,e){return ge.apply(this,arguments)}function ge(){return ge=(0,_.Z)(function*(i,e){let s=yield i[e];return s instanceof o.FilterGroup||(s=new o.FilterGroup,i[e]=s),s}),ge.apply(this,arguments)}function rs(i,e,s){return fe.apply(this,arguments)}function fe(){return fe=(0,_.Z)(function*(i,e,s){return(yield qe(i,e)).filters.get(s)||new o.FilterGroup(o.LogicalOperatorType.And)}),fe.apply(this,arguments)}function os(i,e,s,t){return me.apply(this,arguments)}function me(){return me=(0,_.Z)(function*(i,e,s,t){const r=yield qe(i,e);r.add(t,s),i[e]=r}),me.apply(this,arguments)}function as(i,e,s){return i.getViewModelAttributePaths(e,s).map(n=>(0,l.getItemsAttributeName)(n)).map(n=>(0,l.getBusinessRuleFilterAttributeName)(n))}function ye(i,e,s,t,r,n){return Re.apply(this,arguments)}function Re(){return Re=(0,_.Z)(function*(i,e,s,t,r,n){const a=as(i,e,s);for(const p of a){const c=yield rs(i,p,r);c.add(t,n),yield os(i,p,r,c)}}),Re.apply(this,arguments)}let xe=class extends E{_createLookupFilterGroup(e,s){const t=new o.FilterGroup(o.LogicalOperatorType.And),r=new o.CompareFilter(o.ComparisonType.Equal,new o.ColumnExpression({columnPath:e}),new o.ParameterExpression({value:s}));return t.add(r,"lookupFilter"),t}_setFilterForScope(e,s){const t=this.action,r=t.path;if(t.value){const{leftExpression:n,rightExpression:a}=t.value,p=this._createLookupFilterGroup(n,a.value);return ye(e,s,r,p,t.businessRuleUId,t.actionUId)}return ye(e,s,r,new o.FilterGroup,t.businessRuleUId,t.actionUId)}innerApply(e,s){const t=this._setFilterForScope(e,s.id);return(0,u.from)(t)}};xe=(0,d.__decorate)([x({type:"crt.FilterLookup"})],xe);let Ee=class extends E{_getFilter(e){if(e){const s=e.value,t=JSON.parse(s);return o.FilterParser.fromJson(t)}else return new o.FilterGroup}innerApply(e,s){const t=this.action,r=this._getFilter(t.value),n=ye(e,s.id,t.path,r,t.businessRuleUId,t.actionUId);return(0,u.from)(n)}};Ee=(0,d.__decorate)([x({type:"crt.SetFilter"})],Ee);let Ae=class extends oe{constructor(){super(...arguments),this.propertyName="visible"}};Ae=(0,d.__decorate)([x({type:"crt.SetVisibilityPropertyActionApplier"})],Ae);let Be=class extends oe{constructor(){super(...arguments),this.propertyName="readonly"}_getPropertyName(e,s){return e.getInvariabilityPropertyName(s)??this.propertyName}setAttributePropertyValue(e,s,t){const r=this._getPropertyName(e,s);e.setAttributePropertyValue(s,r,t)}resetAttributePropertyValue(e,s){const t=this._getPropertyName(e,s);e.resetAttributePropertyValue(s,t)}};Be=(0,d.__decorate)([x({type:"crt.SetReadonlyPropertyActionApplier"})],Be);let _e=class extends oe{constructor(){super(...arguments),this.propertyName="required"}};_e=(0,d.__decorate)([x({type:"crt.SetRequiredPropertyActionApplier"})],_e);class P{constructor(e){this.typeName="Terrasoft.Core.BusinessRules.Models.Conditions.BaseBusinessRuleDesignCondition",e?this.uId=e?.uId:this.uId=(0,o.generateGuid)()}toMetadata(){return{typeName:this.typeName,uId:this.uId}}copy(){return new P({...this.toMetadata(),uId:(0,o.generateGuid)()})}isValid(){return Boolean(this.uId)}onDataSourceAttributeNameChanged(e,s,t){}getWarningMessages(){return[]}}class O extends P{}class ae{constructor(e){this.typeName="Terrasoft.Core.BusinessRules.Models.BusinessRuleAction",this.enabled=!0,this.uId=e?.uId||(0,o.generateGuid)(),e&&(this.enabled=e.enabled)}toMetadata(){return{typeName:this.typeName,uId:this.uId,enabled:this.enabled}}getTypeName(){return this.typeName}getApplicability(){return[]}isValid(){return!0}onDataSourceAttributeNameChanged(e,s,t){}getAffectedItems(){return[]}getRequiredItems(){return[]}}class m{get dataValueTypeName(){return this._dataValueTypeName}set dataValueTypeName(e){this._dataValueTypeName=e}get isLookup(){return this.dataValueTypeName===l.DataValueTypeItems[o.DataValueType.Lookup].name}get referenceSchemaName(){return this._referenceSchemaName}set referenceSchemaName(e){this._referenceSchemaName!==e&&(this._referenceSchemaName=e)}constructor(e){this.typeName="Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleExpression",this._dataValueTypeName="",this._referenceSchemaName="",this.type=l.BusinessRuleExpressionType.Const,this.uId=e?.uId||(0,o.generateGuid)(),e&&(this._dataValueTypeName=e.dataValueTypeName??"",this.type=e.type||this.type,this._referenceSchemaName=e.referenceSchemaName??"")}toMetadata(){return{typeName:this.typeName,uId:this.uId,type:this.type,dataValueTypeName:this.dataValueTypeName,referenceSchemaName:this.referenceSchemaName}}copy(){return new m({...this.toMetadata(),uId:(0,o.generateGuid)()})}isValid(){return Boolean(this.uId)}onDataSourceAttributeNameChanged(e,s,t){}getAffectedItem(){return null}clear(){throw new Error("Not implemented")}}class T{static register(e,s){this._expressionsTypes.set(e,s)}static _getExpressionType(e){return this._expressionsTypes.get(e)??null}get(e){if(!e)return new m;const s=T._getExpressionType(e.typeName);return s?new s(e):new m(e)}}T._expressionsTypes=new Map;function b(i){return function(e){T.register(i.typeName,e)}}var Ne;let D=Ne=class extends m{constructor(e){super(e),this.typeName="Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleAttributeExpression",this.path="",this.scopeId="",e&&(this.path=e.path,this.scopeId=e.scopeId==="null"?"":e.scopeId)}toMetadata(){return{...super.toMetadata(),path:this.path,scopeId:this.scopeId}}copy(){return new Ne({...this.toMetadata(),uId:(0,o.generateGuid)()})}isValid(){return super.isValid()&&Boolean(this.path)}onDataSourceAttributeNameChanged(e,s,t){this.scopeId===e&&this.path===s&&(this.path=t)}getAffectedItem(){return{name:this.path}}};D=Ne=(0,d.__decorate)([b({typeName:"Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleAttributeExpression"}),(0,d.__metadata)("design:paramtypes",[Object])],D);class N extends ae{constructor(e){super(e),this._expressionFactory=new T,this.typeName="Terrasoft.Core.BusinessRules.Models.BusinessRuleAction",this.executorName="",e&&(this.executorName=e.executorName,this.expression=new D(e.expression),e.value&&(this.value=this._expressionFactory.get(e.value)))}getExpressionAffectedItems(){const e=this.expression?.getAffectedItem()??null;return e?[e]:[]}toMetadata(){return{...super.toMetadata(),executorName:this.executorName,expression:this.expression?.toMetadata(),value:this.value?.toMetadata()}}clone(){return new N(this.toMetadata())}copy(){const e=new N({...this.toMetadata(),uId:(0,o.generateGuid)()});return e.expression=this.expression?.copy(),e.value=this.value?.copy(),e}getApplicability(){if(!this.expression?.path)return[];const s=this.expression.path.split(".").shift();return s?[{path:s}]:[]}isValid(){return super.isValid()&&Boolean(this.expression?.isValid())&&Boolean(this.value?.isValid())}getAffectedItems(){const e=this.getExpressionAffectedItems();return[...super.getAffectedItems(),...e]}}class We extends ae{constructor(){super(...arguments),this.typeName="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionSetProperty"}}class w extends We{constructor(e){super(e),this.items=[],e&&(Array.isArray(e.items)?this.items=e.items:this.items=e.items?.length>0?e.items.split(","):[])}_getAffectedItems(){return(this.items??[]).map(s=>({name:s}))}toMetadata(){return{...super.toMetadata(),items:this.items?.length>0?this.items.join(","):""}}getApplicability(){return this.isValid()?this.items.map(e=>({path:e})):[]}isValid(){return super.isValid()&&this.items?.length>0}getAffectedItems(){return[...super.getAffectedItems(),...this._getAffectedItems()]}}const $e="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionEditableElement";class q extends w{constructor(){super(...arguments),this.typeName=$e}clone(){return new q(this.toMetadata())}copy(){return new q({...this.toMetadata(),uId:(0,o.generateGuid)()})}}var Me;let W=Me=class extends m{constructor(e){super(e),this.typeName="Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleFilterLookupExpression",this.path="",this.filterExpression="",e&&(this.path=e.path,this.filterExpression=e.filterExpression==="null"?"":e.filterExpression)}toMetadata(){return{...super.toMetadata(),path:this.path,filterExpression:this.filterExpression}}copy(){return new Me({...this.toMetadata(),uId:(0,o.generateGuid)()})}isValid(){return super.isValid()&&Boolean(this.path)&&Boolean(this.filterExpression)}getAffectedItem(){return{name:this.path}}};W=Me=(0,d.__decorate)([b({typeName:"Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleFilterLookupExpression"}),(0,d.__metadata)("design:paramtypes",[Object])],W);class $ extends N{constructor(e){super(e),this.typeName="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionFilterLookup",this.clearValue=!1,this.populateValue=!1,e?(this.clearValue=e.clearValue??!1,this.populateValue=e.populateValue??!1):(this.clearValue=!0,this.populateValue=!0),this._processMetadata(e)}_isOldMetadataFormat(e){const s=!!e.expression?.path&&e.expression.path!=="null",t=e.value,r=!!t?.value&&t.value!=="null";return s&&r}_convertOldMetadata(e){const s={...e},t=e.expression?.path||"",n=e.value?.value,a={path:n,filterExpression:""},p={path:t,filterExpression:""};if(n.includes(".")){const[c,...A]=n.split(".");a.path=c,a.filterExpression=A.join(".")}return{...s,leftExpression:a,rightExpression:p}}_processMetadata(e){!e||(this._isOldMetadataFormat(e)&&(e=this._convertOldMetadata(e)),delete this.expression,delete this.value,this.leftExpression=new W(e?.leftExpression),this.rightExpression=new W(e?.rightExpression))}toMetadata(){return{...super.toMetadata(),leftExpression:this.leftExpression?.toMetadata(),rightExpression:this.rightExpression?.toMetadata(),clearValue:this.clearValue,populateValue:this.populateValue}}clone(){return new $({...this.toMetadata()})}copy(){return new $({...super.copy().toMetadata(),leftExpression:this.leftExpression?.toMetadata(),rightExpression:this.rightExpression?.toMetadata(),clearValue:this.clearValue,populateValue:this.populateValue})}getApplicability(){return this.leftExpression?.path?[{path:this.leftExpression.path}]:[]}isValid(){return Boolean(this.leftExpression?.isValid())&&Boolean(this.rightExpression?.path)}getAffectedItems(){const e=this.leftExpression?.getAffectedItem()??null,s=[...super.getAffectedItems()];return e&&s.push(e),s}getRequiredItems(){return[this.rightExpression?.getAffectedItem()].filter(e=>e)}}class z extends w{constructor(){super(...arguments),this.typeName="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionHideElement"}clone(){return new z(this.toMetadata())}copy(){return new z({...this.toMetadata(),uId:(0,o.generateGuid)()})}}const be="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionOptionalElement";class H extends w{constructor(){super(...arguments),this.typeName=be}clone(){return new H(this.toMetadata())}copy(){return new H({...this.toMetadata(),uId:(0,o.generateGuid)()})}}const ze="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionReadonlyElement";class Z extends w{constructor(){super(...arguments),this.typeName=ze}clone(){return new Z(this.toMetadata())}copy(){return new Z({...this.toMetadata(),uId:(0,o.generateGuid)()})}}const Ce="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionRequiredElement";class J extends w{constructor(){super(...arguments),this.typeName=Ce}clone(){return new J(this.toMetadata())}copy(){return new J({...this.toMetadata(),uId:(0,o.generateGuid)()})}}var Te;let G=Te=class extends m{get value(){return this._value}set value(e){this._value!==e&&(this._displayValueInitialized=!1,this._value=e)}get referenceSchemaName(){return super.referenceSchemaName}set referenceSchemaName(e){this.referenceSchemaName!==e&&(super.referenceSchemaName=e,this._displayValueInitialized=!1)}get displayValue(){return this.isLookup&&this.referenceSchemaName?this._displayValueInitialized?this._displayValue:null:(this._displayValue=this.value,this._displayValueInitialized=!0,this._displayValue)}set displayValue(e){this._displayValue=e??"",this._displayValueInitialized=e!=null}get dataValueTypeName(){return super.dataValueTypeName}set dataValueTypeName(e){this.dataValueTypeName!==e&&(super.dataValueTypeName=e,this._displayValueInitialized=!1)}constructor(e){super(e),this.typeName="Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleValueExpression",this._value="",this._displayValue="",this._displayValueInitialized=!1,e&&(this._value=e.value)}initDisplayValue(){var e=this;return(0,_.Z)(function*(){if(e._displayValueInitialized)return Promise.resolve(e._displayValue);if(e.isLookup&&e.referenceSchemaName&&e._value){const s=yield Oe.getLookupValue(e.referenceSchemaName,e._value);e._displayValue=s.displayValue}else e._displayValue=e.value;return e._displayValueInitialized=!0,Promise.resolve(e._displayValue)})()}toMetadata(){return{...super.toMetadata(),value:this.value}}copy(){return new Te({...this.toMetadata(),uId:(0,o.generateGuid)()})}isValid(){return super.isValid()?this.isLookup?(0,o.isGuid)(this.value):this.value!=null&&this.value!=="":!1}clear(){this._value="",this._displayValue="",this._displayValueInitialized=!1}};G=Te=(0,d.__decorate)([b({typeName:"Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleValueExpression"}),(0,d.__metadata)("design:paramtypes",[Object])],G);class K extends N{constructor(e){super(e),this.typeName="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionSetFilter",e&&(this.value=new G(e.value))}clone(){return new K(this.toMetadata())}copy(){return new K(super.copy().toMetadata())}getApplicability(){return this.expression?.path?[{path:this.expression.path}]:[]}}class X extends N{constructor(){super(...arguments),this.typeName="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionSetValue"}clone(){return new X(this.toMetadata())}copy(){return new X(super.copy().toMetadata())}}var ue;(function(i){i.DataSource="DataSource",i.Page="Page"})(ue||(ue={}));class Y extends N{constructor(e){super(e),this.typeName="Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleSetValueItem",this.scope=e?.scopeId??"",this.scope==="null"&&(this.scope="")}clone(){return new Y(this.toMetadata())}copy(){return new Y({...super.copy().toMetadata(),scopeId:this.scope})}toMetadata(){return{...super.toMetadata(),scopeId:this.scope}}getApplicability(){if(!this.expression?.path)return[];const s=this.expression.path.split(".").shift();if(!s)return[];const t={path:s};return this.scope!==""&&(t.applicability=ue.DataSource,t.scope=this.scope),[t]}}class Q extends N{constructor(e){super(e),this.typeName="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionSetValues",this.items=[],e&&(this.items=e.items?.map(s=>new Y(s)))}getExpressionAffectedItems(){return[]}clone(){return new Q(this.toMetadata())}copy(){return new Q({...super.copy().toMetadata(),items:this.items.map(e=>e.toMetadata())})}toMetadata(){const e={...super.toMetadata(),items:this.items?.length>0?this.items.map(s=>s.toMetadata()):[]};return this.items?.length>0&&(delete e.expression,delete e.value),e}getApplicability(){return this.items?.length?this.items.flatMap(e=>e.getApplicability()):[]}isValid(){return this.items?.length>0&&this.items.every(e=>e.isValid())}getAffectedItems(){const s=(this.items??[]).map(t=>t.getAffectedItems()).flat();return[...super.getAffectedItems(),...s]}getRequiredItems(){return this.getAffectedItems()}}class ee extends w{constructor(){super(...arguments),this.typeName="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionShowElement"}clone(){return new ee(this.toMetadata())}copy(){return new ee({...this.toMetadata(),uId:(0,o.generateGuid)()})}}class C{get(e){return e.typeName==="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionShowElement"?new ee(e):e.typeName==="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionHideElement"?new z(e):e.typeName==="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionReadonlyElement"?new Z(e):e.typeName==="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionEditableElement"?new q(e):e.typeName===be?new H(e):e.typeName===Ce?new J(e):e.typeName==="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionFilterLookup"?new $(e):e.typeName==="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionSetFilter"?new K(e):e.typeName==="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionSetValue"?new X(e):e.typeName==="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionSetValues"?new Q(e):new N(e)}}C.\u0275fac=function(e){return new(e||C)},C.\u0275prov=h.\u0275\u0275defineInjectable({token:C,factory:C.\u0275fac,providedIn:"root"});const le="Terrasoft.Core.BusinessRules.Models.Conditions.BusinessRuleGroupCondition";class se extends P{constructor(e){super(e),this._businessRuleDesignExpressionFactory=new T,this.typeName="Terrasoft.Core.BusinessRules.Models.Conditions.BusinessRuleCondition",this.comparisonType=l.BusinessRuleExpressionComparisonType.IsNull,e&&(e.leftExpression&&(this.leftExpression=this._businessRuleDesignExpressionFactory.get(e.leftExpression)),e.rightExpression&&(this.rightExpression=this._businessRuleDesignExpressionFactory.get(e.rightExpression)),e.comparisonType!=null&&(this.comparisonType=e.comparisonType))}toMetadata(){return{...super.toMetadata(),leftExpression:this.leftExpression?.toMetadata(),rightExpression:this.rightExpression?.toMetadata(),comparisonType:this.comparisonType}}copy(){const e=new se({...this.toMetadata(),uId:(0,o.generateGuid)()});return e.leftExpression=this.leftExpression?.copy(),e.rightExpression=this.rightExpression?.copy(),e}isValid(){if(!super.isValid()||this.comparisonType==null)return!1;const e=Boolean(this.leftExpression?.isValid());switch(this.comparisonType){case l.BusinessRuleExpressionComparisonType.IsNull:case l.BusinessRuleExpressionComparisonType.IsNotNull:return e;case l.BusinessRuleExpressionComparisonType.Equal:case l.BusinessRuleExpressionComparisonType.NotEqual:return e&&Boolean(this.rightExpression?.isValid());default:return!0}}onDataSourceAttributeNameChanged(e,s,t){this.leftExpression.onDataSourceAttributeNameChanged(e,s,t),this.rightExpression?.onDataSourceAttributeNameChanged(e,s,t)}_getAttributeExpressionWarningMessage(e){if(!e.dataValueTypeName)return null;const s=Object.values(l.DataValueTypeItems).find(t=>t.name===e.dataValueTypeName)?.type;return s===o.DataValueType.MAXSIZE_TEXT?{message:"BusinessRules.Errors.MaxSizeInConditionLimitedWarningMessage",type:"warn"}:s===o.DataValueType.RICH_TEXT||s===o.DataValueType.Image?{message:"BusinessRules.Errors.NotSupportedInConditionTypesWarningMessage",type:"error"}:null}getWarningMessages(){const e=[];if(this.comparisonType===l.BusinessRuleExpressionComparisonType.Equal||this.comparisonType===l.BusinessRuleExpressionComparisonType.NotEqual){if(this.leftExpression instanceof D){const s=this._getAttributeExpressionWarningMessage(this.leftExpression);s&&e.push(s)}if(this.rightExpression instanceof D){const s=this._getAttributeExpressionWarningMessage(this.rightExpression);s&&e.push(s)}}return e}}class te extends P{constructor(e){super(e),this.typeName=le,this.logicalOperation=l.LogicalOperation.And,this.conditions=[],e&&(this.logicalOperation=e.logicalOperation,this.conditions=e.conditions?.map(s=>s.typeName===le?new te(s):new se(s))??[])}_copyConditions(){return this.conditions.map(e=>e.copy())}toMetadata(){return{...super.toMetadata(),logicalOperation:this.logicalOperation,conditions:this.conditions.map(e=>e.toMetadata())}}copy(){const e=new te({...this.toMetadata(),uId:(0,o.generateGuid)()});return e.conditions=this._copyConditions(),e}isValid(){return super.isValid()&&this.conditions?this.conditions.length===0?!0:this.conditions.every(s=>s.isValid()):!1}onDataSourceAttributeNameChanged(e,s,t){this.conditions.forEach(r=>r.onDataSourceAttributeNameChanged(e,s,t))}getWarningMessages(){return this.conditions.map(e=>e.getWarningMessages()).flat()}}class He{get(e){return e.typeName===le?new te(e):new se(e)}}class ie{get actions(){return Object.freeze(this._actions)}constructor(e){this._businessRuleDesignActionFactory=new C,this._businessRuleDesignConditionFactory=new He,this._typeName="Terrasoft.Core.BusinessRules.Models.BusinessRuleCase",this._actions=[],this.uId=e?.uId||(0,o.generateGuid)(),e?.condition?this.condition=this._businessRuleDesignConditionFactory.get(e.condition):this.condition=new O,e?.actions?.forEach(s=>{this._actions.push(this._businessRuleDesignActionFactory.get(s))})}_getActionIndex(e){return this.actions.findIndex(s=>s.uId===e.uId)}_actionsUpdateMetadata(e){const s=[];e.actions.forEach(r=>{s.push(r.uId);const n=this._businessRuleDesignActionFactory.get(r);this._getActionIndex(n)!==-1?this.updateAction(n):this.addAction(n)}),this.actions.filter(r=>!s.includes(r.uId)).forEach(r=>this.deleteAction(r))}_getActionsMetadata(){return this.actions.map(e=>e.toMetadata())}_getConditionMetadata(){const e=this.condition;return e&&!(e instanceof O)?e.toMetadata():null}_copyActions(){return this.actions.map(e=>e.copy())}_setActions(e){this._actions=[...e]}_copyCondition(){const e=this.condition;return e&&!(e instanceof O)?e.copy():new O}toMetadata(){const e=this._getConditionMetadata(),s=this._getActionsMetadata();return{typeName:this._typeName,uId:this.uId,condition:e,actions:s}}updateFromMetadata(e){e.condition&&this.updateCondition(this._businessRuleDesignConditionFactory.get(e.condition)),this._actionsUpdateMetadata(e)}addAction(e){if(this._getActionIndex(e)!==-1){console.warn(`Action ${e.uId} already exists`);return}this._actions=[...this._actions,e.clone()]}updateAction(e){const s=this._getActionIndex(e);if(s===-1){console.warn(`Action ${e.uId} not found`);return}this._actions=[...this._actions],this._actions.splice(s,1,e.clone())}deleteAction(e){const s=this._getActionIndex(e);s<0||(this._actions=[...this._actions],this._actions.splice(s,1))}updateCondition(e){this.condition=e}copy(){const e=new ie({...this.toMetadata(),uId:(0,o.generateGuid)()});return e._setActions(this._copyActions()),e.condition=this._copyCondition(),e}onDataSourceAttributeNameChanged(e,s,t){this.condition.onDataSourceAttributeNameChanged(e,s,t),this._actions.forEach(r=>r.onDataSourceAttributeNameChanged(e,s,t))}}function us(i,e){return Object.values(i).indexOf(e)}class ne{constructor(e){this._typeName="Terrasoft.Core.BusinessRules.Models.Trigger",this.name="",this.type=l.BusinessRuleTriggerType.ChangeAttributeValue,this.scopeId="",this.uId=e?.uId||(0,o.generateGuid)(),e&&(this.name=e.name,this.type=Object.values(l.BusinessRuleTriggerType)[e.type||0],this.scopeId=e.scopeId)}toMetadata(){const e=us(l.BusinessRuleTriggerType,this.type);return{typeName:this._typeName,uId:this.uId,name:this.name,type:e,scopeId:this.scopeId}}copy(){return new ne({...this.toMetadata(),uId:(0,o.generateGuid)()})}}class pe{get hasWarnings(){return this.getWarningMessages().length>0}constructor(e,s,t,r,n){this.caption=s,this.schemaName=t,this.schemaCaption=r,this.applicabilityType=n,this._typeName="Terrasoft.Core.BusinessRules.BusinessRule",this.name="",this.enabled=!0,this.triggers=[],this.cases=[],this.needToSave=!1,this.parentUId="",this.parentActionUId="",this.uId=e.uId,this.updateFromMetadata(e)}_updateCase(e){const s=this.cases.find(t=>t.uId===e.uId);if(s){s.updateFromMetadata(e);return}this.addCase(new ie(e))}_casesUpdateMetadata(e){const s=[];e.cases?.forEach(t=>{s.push(t.uId),this._updateCase(t)}),this.cases=this.cases.filter(t=>s.includes(t.uId))}_copyCases(){return this.cases?.map(e=>e.copy())}_copyTriggers(){return this.triggers?.map(e=>e.copy())}_isValidCaption(){return this.caption.some(e=>e.value)}addTrigger(e,s,t=""){const r=Object.values(l.BusinessRuleTriggerType).indexOf(s),n=new ne({name:e,type:r,scopeId:t});return this.triggers.push(n),n.uId}addCase(e){this.cases.push(e)}getFirstCase(){let e=this.cases[0];return e||(e=new ie,this.addCase(e),this.getFirstCase())}updateFromMetadata(e){this.parentUId=e.parentUId??"",this.parentActionUId=e.parentActionUId??"",this.name=e.name,this.enabled=e.enabled,this._casesUpdateMetadata(e),this.triggers=e.triggers?.map(s=>new ne(s))??[]}toMetadata(){const e={typeName:this._typeName,uId:this.uId,cases:this.cases.map(s=>s.toMetadata()),triggers:this.triggers.map(s=>s.toMetadata()),name:this.name,enabled:this.enabled};return this.parentUId&&(e.parentUId=this.parentUId),this.parentActionUId&&(e.parentActionUId=this.parentActionUId),e}clone(){const e=new pe(this.toMetadata(),this.caption.clone(),this.schemaName,this.schemaCaption,this.applicabilityType);return e.needToSave=this.needToSave,e}copy(){const e=this.name,s=this.caption.clone();s.forEach(r=>{r.value&&(r.value=`Copy ${r.value}`)});const t=new pe({...this.toMetadata(),uId:(0,o.generateGuid)()},s,this.schemaName,this.schemaCaption,this.applicabilityType);return t.name=`${e} (copy)`,t.cases=this._copyCases(),t.triggers=this._copyTriggers(),t}isValid(){if(!this._isValidCaption())return!1;const s=this.getFirstCase(),t=s?.condition,r=s?.actions;return t?.isValid()&&r?.length>0&&r.every(n=>n.isValid())}showInvalid(){return this.needToSave?!this.isValid():!1}onDataSourceAttributeNameChanged(e,s,t){this.cases.forEach(r=>r.onDataSourceAttributeNameChanged(e,s,t))}getWarningMessages(){const e=[],t=this.getFirstCase()?.condition;return t&&e.push(...t.getWarningMessages()),e}}var Se;let Ve=Se=class extends m{constructor(e){super(e),this.typeName="Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleSysSettingExpression",this.sysSettingName="",e&&(this.sysSettingName=e.sysSettingName)}toMetadata(){return{...super.toMetadata(),sysSettingName:this.sysSettingName}}copy(){return new Se({...this.toMetadata(),uId:(0,o.generateGuid)()})}isValid(){return super.isValid()&&Boolean(this.sysSettingName)}};Ve=Se=(0,d.__decorate)([b({typeName:"Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleSysSettingExpression"}),(0,d.__metadata)("design:paramtypes",[Object])],Ve);var Ie;let we=Ie=class extends m{constructor(e){super(e),this.typeName="Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleSysValueExpression",this.sysValueName="",e&&(this.sysValueName=e.sysValueName)}toMetadata(){return{...super.toMetadata(),sysValueName:this.sysValueName}}copy(){return new Ie({...this.toMetadata(),uId:(0,o.generateGuid)()})}isValid(){return super.isValid()&&Boolean(this.sysValueName)}};we=Ie=(0,d.__decorate)([b({typeName:"Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleSysValueExpression"}),(0,d.__metadata)("design:paramtypes",[Object])],we);var ve;let Fe=ve=class extends m{constructor(e){super(e),this.typeName="Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleFilterValueExpression",this.leftExpression="",e&&(this.leftExpression=e.leftExpression,this.rightExpression=new G(e.rightExpression))}toMetadata(){return{...super.toMetadata(),leftExpression:this.leftExpression,rightExpression:this.rightExpression?.toMetadata()}}copy(){const e=new ve({...this.toMetadata(),uId:(0,o.generateGuid)()});return e.rightExpression=this.rightExpression.copy(),e}isValid(){return super.isValid()&&Boolean(this.leftExpression)&&Boolean(this.rightExpression)&&this.rightExpression.isValid()}getAffectedItem(){return{name:this.leftExpression}}};Fe=ve=(0,d.__decorate)([b({typeName:"Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleFilterValueExpression"}),(0,d.__metadata)("design:paramtypes",[Object])],Fe);let Pe=class extends G{constructor(){super(...arguments),this.typeName="Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleEmptyValueExpression"}isValid(){return!0}};Pe=(0,d.__decorate)([b({typeName:"Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleEmptyValueExpression"})],Pe);var De=f(60944);class ce{get parameterName(){return this._parameterName}set parameterName(e){this._parameterName=e}get expression(){return this._expression}set expression(e){this._expression=e}constructor(e){this._expressionFactory=new T,this.typeName="Terrasoft.Core.BusinessRules.Models.Expressions.ParameterMapping",this._parameterName="",this._expression=null,this.uId=e?.uId||(0,o.generateGuid)(),this._parameterName=e?.parameterName??"",this._expression=this._expressionFactory.get(e?.expression)}toMetadata(){return{typeName:this.typeName,uId:this.uId,expression:this._expression.toMetadata(),parameterName:this._parameterName}}copy(){return new ce({...this.toMetadata(),uId:(0,o.generateGuid)()})}isValid(){return this.parameterName!==""&&this.expression.isValid()}}var Ge;let je=Ge=class extends m{constructor(e){super(e),this.typeName="Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleFormulaExpression",this.parameterMappings=[],this.type=l.BusinessRuleExpressionType.Formula,this.expressionSchema=new De.ExpressionSchema;const s=e?.parameterMappings??[];this.parameterMappings=s.map(t=>new ce(t)),this.expressionSchema=De.ExpressionSchema.fromMetadata(e?.expressionSchema)}toMetadata(){return{...super.toMetadata(),parameterMappings:this.parameterMappings.map(e=>e.toMetadata()),expressionSchema:this.expressionSchema.toMetadata()}}copy(){return new Ge({...this.toMetadata(),uId:(0,o.generateGuid)()})}isValid(){return super.isValid()}clear(){this.expressionSchema=new De.ExpressionSchema,this.parameterMappings=[]}};je=Ge=(0,d.__decorate)([b({typeName:"Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleFormulaExpression"}),(0,d.__metadata)("design:paramtypes",[Object])],je);let Le=class extends m{constructor(){super(...arguments),this.typeName="Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleContextExpression"}};Le=(0,d.__decorate)([b({typeName:"Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleContextExpression"})],Le);var ke=f(2876),R=f(27049);function Ze(i){return i&&"path"in i?i.path:""}function ls(i){const e=[];return i.conditions&&i.conditions.forEach(s=>{const t=Je(s);e.push(...t)}),e}function Je(i){if(Ke(i))return ls(i);const e=i;return[Ze(e.leftExpression),Ze(e.rightExpression)].filter(s=>s)}function ps(i,e){return i.flatMap(s=>e.get(s).getRequiredItems()).map(s=>s.name)}function Ke(i){return i.typeName===le}function Xe(i){return i.map(e=>Je(e)).flat().filter(e=>e!=null)}function cs(i,e){return i.flatMap(s=>s.cases.flatMap(t=>ps(t.actions,e)))}function hs(i){return!i.cases||i.cases.length===0?[]:i.cases.map(e=>e.condition).filter(e=>e!=null)}function Ye(i){return i.map(e=>hs(e)).flat()}var Qe=f(97600);const ds=[l.BusinessRuleExpressionType.Const,l.BusinessRuleExpressionType.SysValue,l.BusinessRuleExpressionType.SysSetting],gs=new Set(ds);function es(i){return i?!!i.type&&gs.has(i.type):!0}function fs(i){return i.conditions?i.conditions.every(e=>ss(e)):!1}function ss(i){if(!i)return!1;if(Ke(i))return fs(i);const e=i;return(0,Qe.isNil)(e.leftExpression)&&(0,Qe.isNil)(e.rightExpression)?!1:es(e.leftExpression)&&es(e.rightExpression)}function ts(i){return i.some(e=>e.type===l.BusinessRuleTriggerType.ContextReady)}function ms(i,e){return ts(i)?e.some(s=>ss(s)):!1}function ys(i,e){return ts(i)?e.some(s=>s.cases?.some(t=>!t.condition)):!1}class S{_canExecuteByConditionsAttributePaths(e,s){const t=e.filter(n=>n.type!==l.BusinessRuleTriggerType.DataLoaded).map(n=>n.name);if(!t||t.length===0)return!1;const r=new Set(Xe(s));return t.some(n=>r.has(n))}canExecute(e,s){if(!s||s.length===0)return!1;const t=Ye(s),r=ms(e.triggers,t),n=ys(e.triggers,s);return r||n?!0:this._canExecuteByConditionsAttributePaths(e.triggers,t)}}S.\u0275fac=function(e){return new(e||S)},S.\u0275prov=h.\u0275\u0275defineInjectable({token:S,factory:S.\u0275fac});class V{constructor(e){this._httpClient=e,this._businessRulesScopes=new Map,this._cachedLoadScopesRequests=new Map,this.serviceEndpoint="/ServiceModel/BusinessRulesManagerService.svc/",this.getBusinessRulesConfigMethodName="GetBusinessRules"}_getCachedBusinessRulesScopes(e){const s=[];return e.forEach(t=>{this._businessRulesScopes.has(t.scopeName)&&s.push({rules:this._businessRulesScopes.get(t.scopeName),scopeName:t.scopeName})}),s}_mapResponseToBusinessRules(e){return!e?.businessRules||e.businessRules.length===0?[]:e.businessRules.map(s=>{const t=JSON.parse(s.businessRulesConfig);return{scopeName:s.schemaName,rules:t}})}_getContextsScopeNames(e){return e.map(s=>s.scopeName)}_getContextsScopeNamesRequestKey(e){return this._getContextsScopeNames(e).join("_")}_getCachedLoadScopesRequest(e){const s=this._getContextsScopeNames(e),t=[...this._cachedLoadScopesRequests.keys()].find(r=>s.every(n=>r.includes(n)));return this._cachedLoadScopesRequests.get(t)}_getNotLoadedBusinessRulesScopes(e){if(e.length===0)return(0,u.of)([]);const s=this._getContextsScopeNames(e),t=this._getCachedLoadScopesRequest(e);if(t)return t.request$.pipe((0,u.map)(p=>p.filter(c=>s.includes(c.scopeName))));const r=`${this.serviceEndpoint}${this.getBusinessRulesConfigMethodName}`,n={scopes:e.map(p=>({name:p.scopeName,type:p.scopeType,modelType:p.modelType}))},a=this._httpClient.post(r,n).pipe((0,u.map)(p=>this._mapResponseToBusinessRules(p)),(0,u.tap)(p=>{p.forEach(c=>{this._businessRulesScopes.has(c.scopeName)||this._businessRulesScopes.set(c.scopeName,c.rules)})}),(0,u.tap)(()=>{const p=this._getContextsScopeNamesRequestKey(e);this._cachedLoadScopesRequests.delete(p)}),(0,u.share)());return this._cachedLoadScopesRequests.set(this._getContextsScopeNamesRequestKey(e),{request$:a,scopeNames:s}),a}getBusinessRulesByContexts(e){const s=this._getCachedBusinessRulesScopes(e),t=e.filter(n=>!this._businessRulesScopes.has(n.scopeName));return this._getNotLoadedBusinessRulesScopes(t).pipe((0,u.map)(n=>[...s,...n]))}}V.\u0275fac=function(e){return new(e||V)(h.\u0275\u0275inject(ke.HttpClient))},V.\u0275prov=h.\u0275\u0275defineInjectable({token:V,factory:V.\u0275fac});const is=new Map([[0,l.BusinessRuleTriggerType.ChangeAttributeValue],[1,l.BusinessRuleTriggerType.ChangeAttributeProperty],[2,l.BusinessRuleTriggerType.DataLoaded]]);function Ue(i){return is.has(i)?is.get(i):l.BusinessRuleTriggerType.DataLoaded}class j{constructor(e,s){this._businessRulesManager=e,this._businessRuleDesignActionFactory=s,this._scopeAttributes=[]}_filterTriggers(e,s){const t=s.filter(a=>a.scopeName===e.parentScopeId),n=s.find(a=>a.scopeName===e.scopeName).rules.map(a=>a.triggers).flat();return e.triggers.filter(a=>{if(a.type===l.BusinessRuleTriggerType.ContextReady||a.type===l.BusinessRuleTriggerType.DataLoaded)return!0;const p=n.some(B=>B&&B.name===a.name&&Ue(B.type)===a.type),A=t.flatMap(B=>B.rules.flatMap(Bs=>Bs.triggers)).some(B=>B.name===a.name&&Ue(B.type)===a.type);return p||A})}_filterAttributes(e){const s=this._scopeAttributes.find(n=>n.scopeName===e.scopeName).attributes,t=this._scopeAttributes.filter(n=>n.scopeName!==e.scopeName).flatMap(n=>[...n.attributes]);return e.attributes.filter(n=>s.includes(n.attributeName)||t.includes(n.attributeName)||n.isSignificant)}_cacheUsedAttributes(e){e.forEach(s=>{if(!this._scopeAttributes.find(t=>t.scopeName===s.scopeName)){const t=Ye(s.rules),r=Xe(t),n=cs(s.rules,this._businessRuleDesignActionFactory);this._scopeAttributes.push({scopeName:s.scopeName,attributes:[...r,...n]})}})}filter(e){return this._businessRulesManager.getBusinessRulesByContexts(e).pipe((0,u.tap)(s=>this._cacheUsedAttributes(s)),(0,u.map)(s=>e.map(t=>({...t,attributes:this._filterAttributes(t),triggers:this._filterTriggers(t,s)}))))}}j.\u0275fac=function(e){return new(e||j)(h.\u0275\u0275inject(V),h.\u0275\u0275inject(C))},j.\u0275prov=h.\u0275\u0275defineInjectable({token:j,factory:j.\u0275fac,providedIn:"root"});class I{canExecute(e,s,t){const r=t.map(n=>n.triggers).flat();return r.length===0?!1:r.some(n=>{const a=Ue(n.type);if(a===l.BusinessRuleTriggerType.DataLoaded&&e.scopeType===y.Model)return e.triggers.some(c=>c.type===l.BusinessRuleTriggerType.DataLoaded);if(!n.scopeId)return e.triggers.some(c=>c.name===n.name&&c.type===a);const p=s.find(c=>c.scopeId===n.scopeId);return p==null?!1:p.triggers.some(c=>c.name===n.name&&c.type===a)})}}I.\u0275fac=function(e){return new(e||I)},I.\u0275prov=h.\u0275\u0275defineInjectable({token:I,factory:I.\u0275fac});class v{constructor(e,s,t,r,n,a,p){this._businessRulesManager=e,this._businessRulesTriggerExecutor=s,this._businessRulesConditionExecutor=t,this._httpClient=r,this._messageChannelService=n,this._featureService=a,this._contextFilter=p,this._businessRulesResponseEventName="BusinessRuleExecutionResponse",this._serviceUrl="ServiceModel/BusinessRulesEngineService.svc/Execute",this._businessRulesRequestEventName="BusinessRuleExecutionRequest",this._businessRuleDesignActionFactory=new C}_featureStates(){return(0,u.from)(this._featureService.getFeaturesState(["BRules-UseHttpChannel","BRules-DisableContextOptimization"])).pipe((0,R.map)(([e,s])=>({useHttpChannel:e,disableContextOptimization:s})))}_sendWebSocketMessage(e){const s=(0,o.generateGuid)();return e.businessRulesSessionId=s,new u.Observable(t=>{const r=this._messageChannelService.messageEvent$.pipe((0,R.map)(n=>n.body),(0,R.filter)(n=>n!=null),(0,R.filter)(n=>n.eventName===this._businessRulesResponseEventName),(0,R.filter)(n=>n.businessRulesSessionId===s),(0,R.map)(n=>n.payload)).subscribe({next:n=>{r.unsubscribe(),n.success?t.next(n.businessRulesResponse):(console.error("An error occurred during business rules execution. "+n.errorInfo.errorCode+": "+n.errorInfo.message),t.next([])),t.complete()},error:n=>{r.unsubscribe(),console.error("An error occurred during business rules execution. "+n.errorCode+": "+n.message),t.next([]),t.complete()},complete:()=>{r.unsubscribe(),t.error("WebSocket channel closed")}});this._messageChannelService.sendMessage(e,l.MessageChannelType.PTP).pipe((0,u.take)(1)).subscribe()})}_createWebSocketRequest(e){return{eventName:this._businessRulesRequestEventName,contexts:e}}_executeUsingWebSocket(e){const s=this._createWebSocketRequest(e);return this._sendWebSocketMessage(s)}_logErrorMessageAndReturnDefBusinessRuleResponse(e){return console.error("An error occurred during business rules execution. "+e.errorCode+": "+e.message),(0,u.of)([])}_executeUsingHttp(e){return this._httpClient.post(this._serviceUrl,{contexts:e},{headers:new ke.HttpHeaders({"Content-Type":"application/json"})}).pipe((0,R.mergeMap)(s=>s.success?(0,u.of)(s.businessRulesResponse):this._logErrorMessageAndReturnDefBusinessRuleResponse(s.errorInfo)),(0,R.catchError)(s=>this._logErrorMessageAndReturnDefBusinessRuleResponse(s)))}_canExecuteBusinessRulesByContexts(e){return this._businessRulesManager.getBusinessRulesByContexts(e).pipe((0,R.map)(s=>{const t=s.filter(r=>r.rules&&r.rules.length>0);return t.length===0?!1:t.some(r=>{const n=e.find(A=>A.scopeName===r.scopeName),a=e.filter(A=>A.parentScopeId===n.scopeId),p=this._businessRulesTriggerExecutor.canExecute(n,a,r.rules),c=this._businessRulesConditionExecutor.canExecute(n,r.rules);return p||c})}))}_getContextsWithScope(e){return e.filter(s=>s.scopeName&&s.scopeId)}_getBusinessRuleActions(e){return e.cases.map(s=>s.actions).flat().filter(s=>s.enabled).map(s=>this._businessRuleDesignActionFactory.get(s))}_getBusinessRuleAffectedAttributes(e){return this._getBusinessRuleActions(e).map(t=>t.getAffectedItems()).flat()}_getAffectedAttributes(e){let s=e.rules.filter(t=>t.enabled).map(t=>this._getBusinessRuleAffectedAttributes(t)).flat();return s=this._getUniqueAffectedAttributes(s),s.forEach(t=>{t.scopeName=e.scopeName}),s}_getUniqueAffectedAttributes(e){const s=e.map(r=>[r.name,r]);return[...new Map(s).values()]}_execute(e){return this._featureStates().pipe((0,R.switchMap)(({useHttpChannel:s,disableContextOptimization:t})=>(0,u.forkJoin)({useHttpChannel:(0,u.of)(s),useContext:t?(0,u.of)(e):this._contextFilter.filter(e)})),(0,R.switchMap)(({useHttpChannel:s,useContext:t})=>s?this._executeUsingHttp(t):this._executeUsingWebSocket(t)))}execute(e){const s=this._getContextsWithScope(e);return s.length===0?(0,u.of)([]):this._canExecuteBusinessRulesByContexts(e).pipe((0,R.switchMap)(t=>t?this._execute(s):(0,u.of)([])))}getAffectedAttributes(e){var s=this;return(0,_.Z)(function*(){if(e.length===0)return[];const t=e.filter(a=>a.scopeName!=null),n=(yield(0,u.firstValueFrom)(s._businessRulesManager.getBusinessRulesByContexts(t))).filter(a=>a.rules&&a.rules.length>0);return n.length===0?[]:n.map(a=>s._getAffectedAttributes(a)).flat()})()}}v.\u0275fac=function(e){return new(e||v)(h.\u0275\u0275inject(V),h.\u0275\u0275inject(I),h.\u0275\u0275inject(S),h.\u0275\u0275inject(ke.HttpClient),h.\u0275\u0275inject(l.MessageChannelService),h.\u0275\u0275inject(o.FeatureService),h.\u0275\u0275inject(j))},v.\u0275prov=h.\u0275\u0275defineInjectable({token:v,factory:v.\u0275fac});class F{constructor(e){this._actionApplierFactory=e}applyRules(e,s){if(s&&s.length>0){const t=s.map(r=>{const n={id:r.scopeId,name:r.scopeName,type:r.scopeType,triggers:r.triggers};if(r.actions.length===0)return(0,u.of)(null);const a=r.actions.map(p=>this._actionApplierFactory.get(p).apply(e,n));return(0,u.forkJoin)(a)});return(0,u.forkJoin)(t)}return(0,u.of)(null)}}F.\u0275fac=function(e){return new(e||F)(h.\u0275\u0275inject(g))},F.\u0275prov=h.\u0275\u0275defineInjectable({token:F,factory:F.\u0275fac});class L{constructor(e){this._storageService=e,this._isBusinessRulesPropertiesPanelExpandedKey="isBusinessRulesPropertiesPanelExpanded",this._isBusinessRulePropertiesPanelExpanded=!0;const s=this._storageService.get(this._isBusinessRulesPropertiesPanelExpandedKey);this._isBusinessRulePropertiesPanelExpanded=s==="true",this.businessRulesPropertiesPanelExpandedChanged$=new u.BehaviorSubject(this._isBusinessRulePropertiesPanelExpanded)}changeBusinessRulePropertiesPanelExpandedState(e){e===void 0&&(e=!this._isBusinessRulePropertiesPanelExpanded),this._isBusinessRulePropertiesPanelExpanded=e,this._storageService.set(this._isBusinessRulesPropertiesPanelExpandedKey,`${e}`),this.businessRulesPropertiesPanelExpandedChanged$.next(e)}}L.\u0275fac=function(e){return new(e||L)(h.\u0275\u0275inject(l.StorageService))},L.\u0275prov=h.\u0275\u0275defineInjectable({token:L,factory:L.\u0275fac});function Rs(){return`BusinessRule_${(0,o.generateGuid)().substring(0,7)}`}function xs(i,e){return!!e?.find(t=>!t.scopeId&&t.triggers.find(r=>r.name===i.name))}function Es(i,e){return!!e?.find(t=>t.scopeName===i.scopeName&&t.triggers?.find(r=>r.name===i.name))}function As(i,e,s){if(e.scopeName===i){if(xs(e,s))return!1}else if(Es(e,s))return!1;return!0}class k{}k.\u0275fac=function(e){return new(e||k)},k.\u0275mod=h.\u0275\u0275defineNgModule({type:k}),k.\u0275inj=h.\u0275\u0275defineInjector({providers:[v,V,F,g,I,S]});class he extends ae{constructor(e){super(),this.uId=e?.uId||(0,o.generateGuid)(),this.customField=e?.customField||"",this.typeName=e?.typeName||""}toMetadata(){return{uId:this.uId,typeName:this.typeName,customField:this.customField}}clone(){return new he(this.toMetadata())}copy(){return new he({...this.toMetadata(),uId:(0,o.generateGuid)()})}onDataSourceAttributeNameChanged(e,s){throw new Error("Method not implemented.")}}},8239:(ns,re,f)=>{f.d(re,{Z:()=>o});function d(l,U,u,h,g,x,y){try{var M=l[x](y),E=M.value}catch(_){u(_);return}M.done?U(E):Promise.resolve(E).then(h,g)}function o(l){return function(){var U=this,u=arguments;return new Promise(function(h,g){var x=l.apply(U,u);function y(E){d(x,h,g,y,M,"next",E)}function M(E){d(x,h,g,y,M,"throw",E)}y(void 0)})}}}}]);
